<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Windows PowerShell进阶(32) 七牛云批量自动上传图片"><meta name="keywords" content="进阶,.NET,qiniu,Http,WebAuto"><meta name="author" content="超速蜗牛,undefined"><meta name="copyright" content="超速蜗牛"><title>Windows PowerShell进阶(32) 七牛云批量自动上传图片【超速蜗牛的博客】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"AOHMI93W80","apiKey":"3f74c7e8113768c69c3eedfd6540618f","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析"><span class="toc-number">2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析C-代码"><span class="toc-number">3.</span> <span class="toc-text">分析C#代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开发powershell脚本"><span class="toc-number">4.</span> <span class="toc-text">开发powershell脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#设置参数"><span class="toc-number">4.1.</span> <span class="toc-text">设置参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用到的函数"><span class="toc-number">4.2.</span> <span class="toc-text">用到的函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化，自检等"><span class="toc-number">4.3.</span> <span class="toc-text">初始化，自检等</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#核心代码"><span class="toc-number">4.4.</span> <span class="toc-text">核心代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#打印输出，保存结果"><span class="toc-number">4.5.</span> <span class="toc-text">打印输出，保存结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">超速蜗牛</div><div class="author-info-description">Learn PowerShell.</div><div class="links-buttons"><a class="links-button button-hover" href="https://gitee.com/chaoyuew" target="_blank">Gitee<i class="icon-dot bg-color6"></i></a><a class="links-button button-hover" href="mailto:348001390@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color7"></i></a><a class="links-button button-hover" href="tencent://message/?uin=348001390&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color6"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">35</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">44</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">2</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">超速蜗牛的博客</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">Windows PowerShell进阶(32) 七牛云批量自动上传图片</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-09-03 | 更新于 2019-09-03</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/powershell/">powershell</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/进阶/">进阶</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/NET/">.NET</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/qiniu/">qiniu</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/Http/">Http</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/WebAuto/">WebAuto</a></div></div></div><div class="main-content"><p>本文首发于本人公众号SPPS178,现搬运过来,较原文有所改动.</p>
<p>2019/09/03 – 现在已不用七牛云,改用了微博图床,此文权当技术学习.</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>因为微信公众号自带的编辑页面不支持语法高亮等高级编辑用途，所以我一直在用<a href="http://md.aclickall.com" target="_blank" rel="noopener">Md2All</a>在线编辑公众号文章，这是一个用<code>Markdown</code>语法编辑文章的网站，推荐给大家使用。</p>
<p>最近遇到的一个问题是，几乎我每次编辑新的文章都要用到图片，在Md2All需要用到图片外链插入图片，搞得我每个图片都要先上传到微信，然后再用F12去抓取外链，很麻烦事。</p>
<a id="more"></a>

<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpqzu0y7j313j0kkn1u.jpg"><br><div>32-1 Get-Wechat-Image</div></center>


<p>所以就上网找了一个类似云盘的一个网站：<code>七牛云</code>，专门用来存储图片。它有丰富的API可以用来自动化操作，这正是我想要的.</p>
<p>注册完并且创建好存储空间后找到并记下以下5个参数，后面脚本要用到。</p>
<ol>
<li>Domain (图中外链默认域名)</li>
<li>AccessKey</li>
<li>SecretKey</li>
<li>Bucket</li>
<li>Zone</li>
</ol>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpsba0efj312e0phjtc.jpg"><br><div>32-2 七牛云API参数</div></center>

<p>我们可以看到主流语言的SDK(<a href="https://developer.qiniu.com/sdk#official-sdk" target="_blank" rel="noopener">七牛云C#开发中心</a>)都有，虽然没有powershell，但是有C#的API我们就可以用powershell来实现。接下来开始分析实现步骤。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpsoi4c6j30rp0ms75g.jpg"><br><div>32-3 七牛云开发者中心</div></center>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>我们按照C# API的安装步骤下载好zip解压好打开.\tools\net40，里面的Newtonsoft.Json.dll和nunit.framework.dll就是C#语言需要用到的2个DLL文件。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpt328p8j30rp0lgjs7.jpg"><br><div>32-4 Dependency DLL</div></center>


<p>但是我们现在要用powershell，那么就要把七牛云C#工程本身编译为DLL。这里推荐用VS(Visual Studio)编译，目前社区版都是免费的了。还是打开之前下载下来的解压后的文件夹，按照下面步骤编译，编译好后在.\bin\文件下找到Qiniu.dll。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mptdonelj30mm0jgjt0.jpg"><br><div>32-5 编译七牛C#主DLL</div></center>

<p>至此powershell所需的3个DLL完全搞定了，我们把它们3个放在一个相同的文件下(假使c:\temp\qiniu)，并和上面的5个参数一起保存到XML配置文件里面(文末我会上传所有文件，你下载下来后参数改成自己对应的就好了)。然后就可以准备写powershell脚本。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mptqff2mj30nn08yt90.jpg"><br><div>32-6 XML配置文件</div></center>

<h3 id="分析C-代码"><a href="#分析C-代码" class="headerlink" title="分析C#代码"></a>分析C#代码</h3><center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpu4nmzzj30ut0k9q47.jpg"><br><div>32-7 C#上传文件代码</div></center>

<p>在着手写powershell代码之前，我们要先看下C#的源码。我们还在之前七牛云开发者中心页面查看C#上传文件的实例代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Mac mac = new Mac(AccessKey, SecretKey);</span><br><span class="line">// 上传文件名</span><br><span class="line">string key = &quot;key&quot;;</span><br><span class="line">// 本地文件路径</span><br><span class="line">string filePath = &quot;D:\\tools\\putty.exe&quot;;</span><br><span class="line">// 存储空间名</span><br><span class="line">string Bucket = &quot;7qiniu&quot;;</span><br><span class="line">// 设置上传策略，详见：https://developer.qiniu.com/kodo/manual/1206/put-policy</span><br><span class="line">PutPolicy putPolicy = new PutPolicy();</span><br><span class="line">putPolicy.Scope = Bucket;</span><br><span class="line">putPolicy.SetExpires(3600);</span><br><span class="line">putPolicy.DeleteAfterDays = 1;</span><br><span class="line">string token = Auth.CreateUploadToken(mac, putPolicy.ToJsonString());</span><br><span class="line">Config config = new Config();</span><br><span class="line">// 设置上传区域</span><br><span class="line">config.Zone = Zone.ZONE_CN_East;</span><br><span class="line">// 设置 http 或者 https 上传</span><br><span class="line">config.UseHttps = true;</span><br><span class="line">config.UseCdnDomains = true;</span><br><span class="line">config.ChunkSize = ChunkUnit.U512K;</span><br><span class="line">// 表单上传</span><br><span class="line">FormUploader target = new FormUploader(config);</span><br><span class="line">HttpResult result = target.UploadFile(filePath, key, token, null);</span><br><span class="line">Console.WriteLine(&quot;form upload result: &quot; + result.ToString());</span><br></pre></td></tr></table></figure>

<p>我们以第一行<code>Mac mac = new Mac(AccessKey, SecretKey);</code>为例，看下怎么转化为powershell代码。首先我们要找到<code>Mac</code>这个类的完整<code>命名空间</code>，可在VS里面找到如下结构Qiniu–&gt;Util–&gt;Mac</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpufwj60j308w08yglk.jpg"><br><div>32-8 完整类目录</div></center>

<p>那么在powershell中实现同样的创建一个新的Mac类的方法如下，其他类的创建同理：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mac mac = new Mac(AccessKey, SecretKey);  # C#语法</span></span><br><span class="line"><span class="variable">$msc</span>=[Qiniu.Util.Mac]::new(<span class="variable">$AccessKey</span>, <span class="variable">$SecretKey</span>) <span class="comment"># powershell语法</span></span><br><span class="line"><span class="comment"># we run below command to get the $msc type and found its name is Mac</span></span><br><span class="line"><span class="comment"># which means we successfully create the Mac class</span></span><br><span class="line"><span class="variable">$msc</span>.GetType()</span><br><span class="line"></span><br><span class="line">IsPublic IsSerial Name                                     BaseType</span><br><span class="line">-------- -------- ----                                     --------</span><br><span class="line">True     False    Mac                                      System.Object</span><br></pre></td></tr></table></figure>

<h3 id="开发powershell脚本"><a href="#开发powershell脚本" class="headerlink" title="开发powershell脚本"></a>开发powershell脚本</h3><p>请确保这个时候上文说的3个DLL文件和XML文件你已经修改保存好。</p>
<p>说下我个人思路，大家在用的时候不一定要和我的一致。</p>
<ol>
<li>指定一个文件夹，脚本读取里面的文件然后上传</li>
<li>可以过滤文件，比如只上传.txt或者.jpg等文件</li>
<li>需要知道每一个文件上传成功与否，文件在七牛云的名字以及对应的外链，这个我用csv存储最终结果</li>
<li>确保返回的外链是真实有效可访问的</li>
</ol>
<h4 id="设置参数"><a href="#设置参数" class="headerlink" title="设置参数"></a>设置参数</h4><p>注释说明一切，大家自己看吧。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[CmdletBinding()]param(</span><br><span class="line">    [ValidateScript(&#123;<span class="built_in">test-path</span> <span class="variable">$_</span>&#125;)]                           </span><br><span class="line">    [string]<span class="variable">$upload_folder</span>=<span class="variable">$PSScriptRoot</span>,                       <span class="comment"># the folder contains the files we need to upload, default current folder</span></span><br><span class="line">    [Parameter(Mandatory=<span class="literal">$False</span>)]                               </span><br><span class="line">    [string]<span class="variable">$file_filter</span>=<span class="string">'*'</span>,                                   <span class="comment"># what kind of files we care to upload, such extension like txt, jpg ...</span></span><br><span class="line">    [ValidateScript(&#123;<span class="built_in">test-path</span> <span class="variable">$_</span>&#125;)]                                        </span><br><span class="line">    [string]<span class="variable">$qiniu_config</span>=<span class="string">"<span class="variable">$PSScriptRoot</span>\qiniu_config.xml"</span>,     <span class="comment"># the qiuniu config we need to load for all the key values</span></span><br><span class="line">    [string]<span class="variable">$log_file</span>=<span class="string">"<span class="variable">$PSScriptRoot</span>\Upload-FileToQiNiu.log"</span>,   <span class="comment"># the log file we record process</span></span><br><span class="line">    [ValidateScript(&#123;<span class="variable">$_</span> -imatch <span class="string">"\.csv$"</span>&#125;)]                     <span class="comment"># must be csv file</span></span><br><span class="line">    [string]<span class="variable">$out_file</span>=(<span class="string">"<span class="variable">$PSScriptRoot</span>\&#123;0&#125;-Upload-FileToQiNiu.csv"</span> -f (<span class="built_in">Get-Date</span>).ToString(<span class="string">"MMdd-HHmm"</span>)) <span class="comment"># the csv file to save the result</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="用到的函数"><a href="#用到的函数" class="headerlink" title="用到的函数"></a>用到的函数</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span> <span class="built_in">Write-Log</span>()&#123;</span><br><span class="line">    <span class="comment">###省略不写了，占文章空间，文末会有码云连接</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">Function</span> Test-URIConnection(<span class="variable">$uri</span>)&#123; </span><br><span class="line">    <span class="comment"># this is used to test if the uploaded file external link can be access when it's been uploaded to qiniu</span></span><br><span class="line">    <span class="comment"># reference link https://www.petri.com/testing-uris-urls-powershell</span></span><br><span class="line">    <span class="variable">$test_uri_paramter</span>= @&#123;</span><br><span class="line">        UseBasicParsing = <span class="literal">$True</span></span><br><span class="line">        DisableKeepAlive = <span class="literal">$True</span></span><br><span class="line">        Uri = <span class="variable">$uri</span></span><br><span class="line">        Method = <span class="string">'Head'</span></span><br><span class="line">        ErrorAction = <span class="number">4</span></span><br><span class="line">        TimeoutSec = <span class="number">30</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Try</span>&#123;</span><br><span class="line">        <span class="keyword">Switch</span>((<span class="built_in">Invoke-WebRequest</span> @test_uri_paramter ).statuscode)&#123;</span><br><span class="line">            <span class="number">200</span>     &#123;<span class="keyword">return</span> <span class="literal">$true</span>&#125;</span><br><span class="line">            default &#123;<span class="keyword">return</span> <span class="literal">$false</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;Catch&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">$false</span></span><br><span class="line">    &#125;<span class="keyword">Finally</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">Function</span> Exit-Script()&#123;</span><br><span class="line">    <span class="comment">###省略不写了，占文章空间，文末会有码云连接</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Write-Log</code>(这个之前都有说过的)和<code>Exit-Script</code>都很简单，我就省略不写了，肯定一眼就能看出来作用。<code>Test-URIConnection</code>这个函数是我参考网友的，注释里面有参考链接，我是在他原有脚本基础上改写的，主要目的就是测试返回外链是否有效。这个用到了powershell自带的一个cmdlets <code>Invoke-WebRequest</code>，这个我们以后讲到网页自动化/爬虫的时候会用到，有兴趣的可以先自行了解下。</p>
<h4 id="初始化，自检等"><a href="#初始化，自检等" class="headerlink" title="初始化，自检等"></a>初始化，自检等</h4><ol>
<li>判断提供要上传的folder里面存在文件</li>
<li>加载XML文件</li>
<li>加载DLL文件</li>
<li>初始化XML文件里的参数</li>
</ol>
<p>这里稍微说下，这几步关于powershell操作XML格式文件的用法还没有说过，这里大家先了解下或者自己Google先自行了解下，后期会试着专门一篇文章来专门说下。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">If</span>(!(<span class="variable">$to_be_uploaded_files</span>=(ls (<span class="built_in">join-path</span> (gi <span class="variable">$upload_folder</span>).fullname <span class="string">"*.<span class="variable">$file_filter</span>"</span>))))&#123;</span><br><span class="line">    Exit-Script <span class="string">"Not found any files matched filter '<span class="variable">$file_filter</span>' in <span class="variable">$upload_folder</span>"</span> <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">Try</span>&#123;</span><br><span class="line">    <span class="variable">$qiniu_config_xml</span>=[xml](cat <span class="variable">$qiniu_config</span> -ea <span class="number">1</span>)</span><br><span class="line">&#125;Catch&#123;</span><br><span class="line">    Exit-Script <span class="variable">$_</span>.Exception.Message <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$qiniu_config_xml</span>.Qiniu.DLL.ChildNodes.<span class="string">'#text'</span>|%&#123;</span><br><span class="line">    <span class="keyword">If</span>( <span class="built_in">test-path</span> (<span class="variable">$this_dll</span>=<span class="string">"<span class="variable">$PSScriptRoot</span>\<span class="variable">$_</span>`.dll"</span>) )&#123;</span><br><span class="line">        [void][System.Reflection.Assembly]::Load([io.file]::ReadAllBytes(<span class="variable">$this_dll</span>))</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        Exit-Script <span class="string">"Not found DLL file: '<span class="variable">$this_dll</span>',might the XML value is empty"</span> <span class="variable">$log_file</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$Domain</span>=<span class="variable">$qiniu_config_xml</span>.Qiniu.Domain</span><br><span class="line"><span class="variable">$AccessKey</span>=<span class="variable">$qiniu_config_xml</span>.Qiniu.AccessKey</span><br><span class="line"><span class="variable">$SecretKey</span>=<span class="variable">$qiniu_config_xml</span>.Qiniu.SecretKey</span><br><span class="line"><span class="variable">$Bucket</span>=<span class="variable">$qiniu_config_xml</span>.Qiniu.Bucket</span><br><span class="line"><span class="variable">$Zone</span>=<span class="variable">$qiniu_config_xml</span>.Qiniu.Zone</span><br><span class="line"><span class="keyword">If</span>( [string]::IsNullOrWhiteSpace(<span class="variable">$Domain</span>) -or `</span><br><span class="line">    [string]::IsNullOrWhiteSpace(<span class="variable">$AccessKey</span>) -or `</span><br><span class="line">    [string]::IsNullOrWhiteSpace(<span class="variable">$SecretKey</span>) -or `</span><br><span class="line">    [string]::IsNullOrWhiteSpace(<span class="variable">$Bucket</span>) -or `</span><br><span class="line">    [string]::IsNullOrWhiteSpace(<span class="variable">$Zone</span>)</span><br><span class="line">)&#123;</span><br><span class="line">    Exit-Script <span class="string">"One or all of the value of |'Domain','AccessKey','SecretKey','Bucket','Zone'| in XML file is empty"</span> <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$Global:upload_result</span>=@() <span class="comment"># for the total result record</span></span><br></pre></td></tr></table></figure>

<h4 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h4><p>核心代码1,C#代码转powershell代码。就按照上面那种方法一个一个给转过来就行了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Try</span>&#123;</span><br><span class="line">    <span class="variable">$msc</span>=[Qiniu.Util.Mac]::new(<span class="variable">$AccessKey</span>, <span class="variable">$SecretKey</span>)</span><br><span class="line">    <span class="variable">$putPolicy</span>=[Qiniu.Storage.PutPolicy]::new()</span><br><span class="line">    <span class="variable">$putPolicy</span>.Scope=<span class="variable">$Bucket</span></span><br><span class="line">    <span class="variable">$putPolicy</span>.SetExpires(<span class="number">7200</span>)</span><br><span class="line">    <span class="variable">$token</span>=[Qiniu.Util.Auth]::CreateUploadToken(<span class="variable">$msc</span>,<span class="variable">$putPolicy</span>.ToJsonString())</span><br><span class="line">    <span class="variable">$config</span> =[Qiniu.Storage.Config]::new()</span><br><span class="line">    <span class="variable">$config</span>.Zone = [Qiniu.Storage.Zone]::<span class="variable">$Zone</span></span><br><span class="line">    <span class="variable">$config</span>.UseHttps = <span class="literal">$true</span>;</span><br><span class="line">    <span class="variable">$config</span>.UseCdnDomains = <span class="literal">$true</span>;</span><br><span class="line">    <span class="variable">$config</span>.ChunkSize =[Qiniu.Storage.ChunkUnit]::U512K</span><br><span class="line">    <span class="variable">$target</span> = [Qiniu.Storage.FormUploader]::new(<span class="variable">$config</span>) </span><br><span class="line">    <span class="variable">$result</span> = [Qiniu.Http.HttpResult]::new()</span><br><span class="line">&#125;Catch&#123;</span><br><span class="line">    Exit-Script <span class="variable">$_</span>.Exception.Message <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心代码2，针对每一个文件，创建哈希表存储上传结果信息。关于外链，七牛云的API是不直接返回的。我上网大概搜了下，好像还要用到另一个算法的API，感觉太麻烦，就直接本地转了，用的是.NET自带的[System.Web.HttpUtility]类。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Foreach</span>( <span class="variable">$file</span> <span class="keyword">in</span> <span class="variable">$to_be_uploaded_files</span>)&#123;</span><br><span class="line">    <span class="variable">$this_upload_result</span>=[pscustomobject]@&#123; <span class="comment"># for csv export use</span></span><br><span class="line">        LocalFile=<span class="variable">$file</span>.fullname</span><br><span class="line">        Zone=<span class="variable">$Zone</span></span><br><span class="line">        Bucket=<span class="variable">$Bucket</span></span><br><span class="line">        QiNiuFile=<span class="variable">$file</span>.name</span><br><span class="line">        UploadSuccess=<span class="literal">$false</span></span><br><span class="line">        ExternalLink = <span class="string">"http://<span class="variable">$Domain</span>/"</span> + [System.Web.HttpUtility]::UrlPathEncode(<span class="variable">$file</span>.name).replace(<span class="string">"#"</span>,<span class="string">"%23"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write-host</span> -fore yellow <span class="string">"Uploading $(<span class="variable">$file</span>.fullname)"</span></span><br><span class="line">    <span class="variable">$result</span>=<span class="variable">$target</span>.UploadFile(<span class="variable">$this_upload_result</span>.LocalFile, <span class="variable">$this_upload_result</span>.QiNiuFile, <span class="variable">$token</span>, <span class="literal">$null</span>) <span class="comment"># [void]</span></span><br><span class="line">    <span class="keyword">If</span>( <span class="number">200</span> <span class="nomarkup">-eq</span> <span class="variable">$result</span>.Code )&#123;</span><br><span class="line">        <span class="keyword">If</span>(Test-URIConnection <span class="variable">$this_upload_result</span>.ExternalLink )&#123;</span><br><span class="line">            <span class="variable">$this_upload_result</span>.UploadSuccess=<span class="literal">$true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$Global:upload_result</span>+=<span class="variable">$this_upload_result</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要说明一下的是<code>[System.Web.HttpUtility]</code>的2个转码的方法都不能完全和七牛云手动上传产生的外链一致。但是如果文件名完全为中文的话，2个方法和七牛云自己转码的外链都是一样的。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span>=<span class="string">'(t-=e s+t te_stt#est).jpg'</span></span><br><span class="line"><span class="built_in">write-host</span> (<span class="string">"UrlEncode    : "</span>+[System.Web.HttpUtility]::UrlEncode(<span class="variable">$file_name</span>))</span><br><span class="line"><span class="built_in">write-host</span> (<span class="string">"UrlPathEncode: "</span>+[System.Web.HttpUtility]::UrlPathEncode(<span class="variable">$file_name</span>))</span><br><span class="line"><span class="built_in">write-host</span> <span class="string">"QiniuEncode  : %28t-=e%20s+t%20te_stt%23est%29.jpg"</span></span><br><span class="line"><span class="comment">#&lt;---------------------below are the output </span></span><br><span class="line">UrlEncode    : (t-%<span class="number">3</span>de+s%<span class="number">2</span>bt+te_stt%<span class="number">23</span>est).jpg</span><br><span class="line">UrlPathEncode: (t-=e%<span class="number">20</span>s+t%<span class="number">20</span>te_stt<span class="comment">#est).jpg</span></span><br><span class="line">QiniuEncode  : %<span class="number">28</span>t-=e%<span class="number">20</span>s+t%<span class="number">20</span>te_stt%<span class="number">23</span>est%<span class="number">29</span>.jpg</span><br></pre></td></tr></table></figure>

<p>比如上面例子中的这个文件:</p>
<ul>
<li>UrlEncode把“=”转为“%3d”，空格转为“+”，“#”转为“%23”</li>
<li>UrlPathEncode把空格转为“%20”，“=”和“#”都没有转</li>
<li>QiniuEncode(七牛云转码的外链)把“#”转为“%23”，空格转为“%20”，“(”转为“%28”，“)”转为“%29”，“=”没有转</li>
</ul>
<p>我实际测试的时候发现“(”和“)”不转，链接也有效，即下面2个都能work，所以我最终用了UrlPathEncode方法，并加了一个replace(“#”,”%23”)方法。这个其实就要求我们给文件起名字的时候规范点，不要起一些乱七八糟的名字。<br><a href="http://pakt6u66x.bkt.clouddn.com/(test).jpg" target="_blank" rel="noopener">http://pakt6u66x.bkt.clouddn.com/(test).jpg</a><br><a href="http://pakt6u66x.bkt.clouddn.com/%28test%29.jpg" target="_blank" rel="noopener">http://pakt6u66x.bkt.clouddn.com/%28test%29.jpg</a></p>
<h4 id="打印输出，保存结果"><a href="#打印输出，保存结果" class="headerlink" title="打印输出，保存结果"></a>打印输出，保存结果</h4><p>最后就是把结果输出到powershell控制台，然后保存到csv中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Try</span>&#123;</span><br><span class="line">    <span class="keyword">If</span>(!(<span class="built_in">test-path</span> <span class="variable">$out_file</span>) )&#123;</span><br><span class="line">        <span class="built_in">New-Item</span> -Path <span class="variable">$out_file</span> -ItemType file -Force -ea <span class="number">1</span>|<span class="built_in">out-null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># add timestamp to the csv file</span></span><br><span class="line">    <span class="variable">$Global:upload_result</span>|ft QiNiuFile,ExternalLink,UploadSuccess -Wrap <span class="comment"># -AutoSize</span></span><br><span class="line">    <span class="variable">$Global:upload_result</span>|<span class="built_in">Export-Csv</span> -Path <span class="variable">$out_file</span> -UseCulture -NoTypeInformation -Encoding UTF8 -Force -ea <span class="number">1</span></span><br><span class="line">    <span class="built_in">write-log</span> Success <span class="string">"The full result has been saved in '<span class="variable">$out_file</span>'"</span> <span class="variable">$log_file</span></span><br><span class="line">    <span class="built_in">write-log</span> Normal <span class="string">"&lt;--------------------------End Of Script Upload-FileToQiNiu.ps1(UFTQ)--------------------------&gt;`r`n"</span> <span class="variable">$log_file</span></span><br><span class="line">&#125;Catch&#123;</span><br><span class="line">    Exit-Script <span class="variable">$_</span>.Exception.Message <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里遇到一个小问题，不知道是不是powershell自己的BUG，就是同样的代码在powershell.exe和powershell_ise.exe显式的格式居然不一样，可以看到powershell_ise.exe最后一行永远对不齐。刚开始还以为我代码没写好，后来改了好几次测试都这样就放弃了，将就看吧，最终结果反正保存在CSV中了。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpv8viwyj30ws085gm2.jpg"><br><div>32-9 显示对比</div></center>

<p>完全跑一遍就是昨天发的那张图片：</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpwgissnj30x40hfdhu.jpg"><br><div>32-10 最终结果</div></center>

<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mpxskg38j31as082q3i.jpg"><br><div>32-11 csv result</div></center>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>完整代码和相关文件已上传码云<a href="https://gitee.com/chaoyuew/powershell/tree/feature/wechat/SPPS32" target="_blank" rel="noopener">https://gitee.com/chaoyuew/powershell/tree/feature/wechat/SPPS32</a></p>
<p>七牛云的API文档很长，我还没有来得及全部仔细看完，如果你在使用脚本过程中出现什么问题，欢迎留言或者加我个人微信Tivoli91，备注PowerShell。我虽不能第一时间回复，但是会在下一篇文章中回复。</p>
<blockquote>
<p>参考链接<br><a href="https://developer.qiniu.com/sdk#official-sdk" target="_blank" rel="noopener">七牛云C#开发中心</a><br><a href="https://www.petri.com/testing-uris-urls-powershell" target="_blank" rel="noopener">测试网址有效性</a><br><a href="https://msdn.microsoft.com/en-us/library/system.web.httputility(v=vs.110).aspx#Methods" target="_blank" rel="noopener">System.Web.HttpUtility</a></p>
</blockquote>
<p>如果你觉得本文有所帮助，欢迎推荐分享给你的朋友。</p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">超速蜗牛</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://chaoyuew.gitee.io/WPS-32-Advanced-Auto-Upload-Bulk-Image-To-QiNiuYun.html">https://chaoyuew.gitee.io/WPS-32-Advanced-Auto-Upload-Bulk-Image-To-QiNiuYun.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chaoyuew.gitee.io">超速蜗牛的博客</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/WPS-33-Advanced-Manage-XML.html"><i class="fas fa-angle-left">&nbsp;</i><span>Windows PowerShell进阶(33) 操作XML</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/WPS-31-Advanced-Understanding-Module.html"><span>Windows PowerShell进阶(31) 理解Module</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2019 By 超速蜗牛</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>