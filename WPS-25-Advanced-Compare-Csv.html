<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Windows PowerShell进阶(25) 比较2个csv的差异"><meta name="keywords" content="进阶,IO,CSV"><meta name="author" content="超速蜗牛,undefined"><meta name="copyright" content="超速蜗牛"><title>Windows PowerShell进阶(25) 比较2个csv的差异【超速蜗牛的博客】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"AOHMI93W80","apiKey":"3f74c7e8113768c69c3eedfd6540618f","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compare-Object"><span class="toc-number">2.</span> <span class="toc-text">Compare-Object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Select-Object"><span class="toc-number">3.</span> <span class="toc-text">Select-Object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析"><span class="toc-number">4.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#首先我们需要写一个脚本，有3个参数，分别为旧的和新的csv-file-他们必须存在而且必须是csv格式file-以及比较结果存放的文件夹"><span class="toc-number">5.</span> <span class="toc-text">首先我们需要写一个脚本，有3个参数，分别为旧的和新的csv #file(他们必须存在而且必须是csv格式file)以及比较结果存放的文件夹.</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#要用到的基本函数"><span class="toc-number">5.1.</span> <span class="toc-text">要用到的基本函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#现在我们已经有了2个csv-file，在正式比较之前我们需要初始化一下变量和预处理："><span class="toc-number">5.2.</span> <span class="toc-text">现在我们已经有了2个csv file，在正式比较之前我们需要初始化一下变量和预处理：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#比较"><span class="toc-number">6.</span> <span class="toc-text">比较</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#表头不对"><span class="toc-number">6.1.</span> <span class="toc-text">表头不对</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#正常比较和比较的结果"><span class="toc-number">6.2.</span> <span class="toc-text">正常比较和比较的结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#再次比较相同csv"><span class="toc-number">6.3.</span> <span class="toc-text">再次比较相同csv</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">超速蜗牛</div><div class="author-info-description">Learn PowerShell.</div><div class="links-buttons"><a class="links-button button-hover" href="https://gitee.com/chaoyuew" target="_blank">Gitee<i class="icon-dot bg-color7"></i></a><a class="links-button button-hover" href="mailto:348001390@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color3"></i></a><a class="links-button button-hover" href="tencent://message/?uin=348001390&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color0"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">30</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">37</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">2</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">超速蜗牛的博客</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">Windows PowerShell进阶(25) 比较2个csv的差异</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-08-26 | 更新于 2019-08-26</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/powershell/">powershell</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/进阶/">进阶</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/IO/">IO</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/CSV/">CSV</a></div></div></div><div class="main-content"><p>本文首发于本人公众号SPPS178,现搬运过来,较原文有所改动.</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>今天讲下我工作当中用到的一个需求：比较2个csv的不同。背景是每次对数据库的改动前后抓取数据库的snapshot，然后对比前后2次snapshot的异同是否和我们实际做的操作一致。</p>
<p>所以假使我们有如下2个csv，我们需要比较他们之间的不同：</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6cxqz8khvj309r04udfq.jpg"><br><div>25-1 old_new_csv_content</div></center>

<a id="more"></a>

<p>最后希望看到的结果如下：</p>
<ol>
<li>user ‘alex’ has role ‘upload’ in old csv, but only has role ‘delete’ in new csv, so the result should be “user ‘alex’ has been revoked role ‘upload’ and granted role ‘delete’”</li>
<li>user ‘tom’ has same role in old &amp; new csv, so there is no difference, hence no data in compare result report</li>
<li>do same action on user ‘tom’ as user ‘alex’</li>
</ol>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6cxs8pls4j30m2059wek.jpg"><br><div>25-2 compare result</div></center>

<h3 id="Compare-Object"><a href="#Compare-Object" class="headerlink" title="Compare-Object"></a>Compare-Object</h3><p>powershell自带了一个cmdlets <code>Compare-Object</code>，就是用来比较2个对象的异同。一般使用如下，详细使用方法相信大家应该知道怎么查询了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一个对象（@(1..5)）称为ReferenceObject，第二个对象（@(3..7)）称为DifferenceObject。</span></span><br><span class="line">compare @(<span class="number">1</span>..<span class="number">5</span>) @(<span class="number">3</span>..<span class="number">7</span>)</span><br><span class="line"><span class="comment"># below is the compare output </span></span><br><span class="line"></span><br><span class="line">InputObject SideIndicator</span><br><span class="line">----------- -------------</span><br><span class="line">          <span class="number">6</span> =&gt;           </span><br><span class="line">          <span class="number">7</span> =&gt;           </span><br><span class="line">          <span class="number">1</span> &lt;=           </span><br><span class="line">          <span class="number">2</span> &lt;=</span><br></pre></td></tr></table></figure>

<p>简单解释下怎么看这个结果：</p>
<ul>
<li>=&gt;: 当前对象（这个例子里是：6和7）在DifferenceObject（@(3..7)），却不在 ReferenceObject（@(1..5)）</li>
<li>&lt;=: 当前对象（这个例子里是：1和2）在ReferenceObject（@(1..5)），却不在 DifferenceObject（@(3..7)）</li>
</ul>
<h3 id="Select-Object"><a href="#Select-Object" class="headerlink" title="Select-Object"></a>Select-Object</h3><p>select-object之前我们也有提到过，可以对管道传来的对象进项筛选：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">compare @(<span class="number">1</span>..<span class="number">5</span>) @(<span class="number">3</span>..<span class="number">7</span>)|select SideIndicator,InputObject <span class="comment"># 调整属性显示顺序</span></span><br><span class="line"><span class="comment"># below is the compare output </span></span><br><span class="line">SideIndicator InputObject</span><br><span class="line">------------- -----------</span><br><span class="line">=&gt;                      <span class="number">6</span></span><br><span class="line">=&gt;                      <span class="number">7</span></span><br><span class="line">&lt;=                      <span class="number">1</span></span><br><span class="line">&lt;=                      <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>select 比较强大的一点是可以用哈希表自定义过滤条件，自定义的哈希表用如下格式：<br><code>@{n=$name;e={$expression}}</code></p>
<ul>
<li>$name： 表头名字</li>
<li>$expression： 对应显示的值，可以看到其是在scriptblock 里面的</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">compare @(<span class="number">1</span>..<span class="number">5</span>) @(<span class="number">3</span>..<span class="number">7</span>) |select InputObject, ` </span><br><span class="line">@&#123;n=<span class="string">'WhereInputObject'</span>;e=&#123;<span class="keyword">if</span>(<span class="variable">$_</span>.SideIndicator <span class="nomarkup">-eq</span> <span class="string">"=&gt;"</span>)&#123;<span class="string">"In2ndObject"</span>&#125;<span class="keyword">else</span>&#123;<span class="string">"In1stObject"</span>&#125;&#125;&#125;</span><br><span class="line">InputObject WhereInputObject</span><br><span class="line">----------- ----------------</span><br><span class="line">          <span class="number">6</span> <span class="keyword">In</span>2ndObject     </span><br><span class="line">          <span class="number">7</span> <span class="keyword">In</span>2ndObject     </span><br><span class="line">          <span class="number">1</span> <span class="keyword">In</span>1stObject     </span><br><span class="line">          <span class="number">2</span> <span class="keyword">In</span>1stObject</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h3 id="首先我们需要写一个脚本，有3个参数，分别为旧的和新的csv-file-他们必须存在而且必须是csv格式file-以及比较结果存放的文件夹"><a href="#首先我们需要写一个脚本，有3个参数，分别为旧的和新的csv-file-他们必须存在而且必须是csv格式file-以及比较结果存放的文件夹" class="headerlink" title="首先我们需要写一个脚本，有3个参数，分别为旧的和新的csv #file(他们必须存在而且必须是csv格式file)以及比较结果存放的文件夹."></a>首先我们需要写一个脚本，有3个参数，分别为旧的和新的csv #file(他们必须存在而且必须是csv格式file)以及比较结果存放的文件夹.</h3><p>不太理解下面参数验证的请回去看<a href="https://chaoyuew.gitee.io/WPS-15-Basic-Function-Parameter.html">Windows PowerShell入门(15) 函数function之参数</a>和<a href="https://chaoyuew.gitee.io/WPS-18-Basic-ScriptBlock.html">Windows PowerShell入门(18) ScriptBlock</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[CmdletBinding()]param(</span><br><span class="line">    [Parameter(Mandatory=<span class="literal">$true</span>,Position=<span class="number">0</span>)]</span><br><span class="line">    [ValidateScript(&#123;(<span class="built_in">test-path</span> <span class="variable">$_</span>) -and [io.path]::GetExtension(<span class="variable">$_</span>) <span class="nomarkup">-eq</span> <span class="string">".csv"</span>&#125;)]</span><br><span class="line">    [string]<span class="variable">$old_csv</span>,</span><br><span class="line">    [Parameter(Mandatory=<span class="literal">$true</span>,Position=<span class="number">1</span>)]</span><br><span class="line">    [ValidateScript(&#123;(<span class="built_in">test-path</span> <span class="variable">$_</span>) -and [io.path]::GetExtension(<span class="variable">$_</span>) <span class="nomarkup">-eq</span> <span class="string">".csv"</span>&#125;)]</span><br><span class="line">    [string]<span class="variable">$new_csv</span>，</span><br><span class="line">    [Parameter(Mandatory=<span class="literal">$false</span>,Position=<span class="number">2</span>)]</span><br><span class="line">    [string]<span class="variable">$compare_path</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>其中<code>[io.path]::GetExtension($_)</code>是.NET的方法，为获取文件的后缀名</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[io.path]::GetExtension(<span class="string">".\compare result.png"</span>) <span class="comment"># 获取文件的后缀名</span></span><br><span class="line">.png</span><br></pre></td></tr></table></figure>

<h4 id="要用到的基本函数"><a href="#要用到的基本函数" class="headerlink" title="要用到的基本函数"></a>要用到的基本函数</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span> <span class="built_in">Write-Log</span>()&#123;</span><br><span class="line">    [CmdletBinding()]param(</span><br><span class="line">        [Parameter(Mandatory=<span class="literal">$true</span>)]</span><br><span class="line">        [ValidateSet(<span class="string">"Warning"</span>, <span class="string">"Error"</span>, <span class="string">"Success"</span>,<span class="string">"Normal"</span>,<span class="string">"Critical"</span>)]</span><br><span class="line">        [string]<span class="variable">$log_type</span>,</span><br><span class="line">        [string]<span class="variable">$log_info</span>,</span><br><span class="line">        [string]<span class="variable">$log_file</span>=<span class="string">"<span class="variable">$home</span>\Documents\WindowsPowerShell\log.txt"</span>,</span><br><span class="line">        [Parameter(Mandatory=<span class="literal">$false</span>)]</span><br><span class="line">        [switch]<span class="variable">$print_to_console</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">If</span>( <span class="variable">$print_to_console</span> )&#123;</span><br><span class="line">        <span class="variable">$color</span> = <span class="keyword">switch</span> -regex (<span class="variable">$log_type</span>)&#123;</span><br><span class="line">            <span class="string">"Error|Critical"</span>  &#123;<span class="string">'red'</span>;<span class="keyword">break</span> &#125;</span><br><span class="line">            <span class="string">"Warning"</span>&#123;<span class="string">'yellow'</span> ;<span class="keyword">break</span>&#125;</span><br><span class="line">            <span class="string">"Success"</span>&#123;<span class="string">'green'</span>  ;<span class="keyword">break</span>&#125;</span><br><span class="line">            default &#123;<span class="string">'white'</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">write-host</span> -fore <span class="variable">$color</span> <span class="variable">$log_info</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">Do</span>&#123;</span><br><span class="line">        <span class="keyword">Try</span>&#123;<span class="string">"&#123;0:yyyy-MM-dd HH:mm:ss&#125;--&#123;1&#125;: &#123;2&#125;"</span> -f (<span class="built_in">get-date</span>),<span class="variable">$log_type</span>,<span class="variable">$log_info</span> |<span class="built_in">Out-File</span> -FilePath <span class="variable">$log_file</span> -Append -Encoding utf8 -Force -ea <span class="number">1</span>;<span class="keyword">break</span>&#125;Catch&#123; <span class="built_in">write-host</span> <span class="variable">$_</span> ; <span class="built_in">read-host</span> <span class="string">" "</span>;sleep -Milliseconds <span class="number">200</span> ;<span class="keyword">if</span>(++<span class="variable">$cnt</span> <span class="nomarkup">-gt</span> <span class="number">10</span>)&#123;<span class="built_in">write-error</span> <span class="string">"wait too long(2s) to write log"</span>;<span class="keyword">break</span>&#125;</span><br><span class="line">        &#125;<span class="keyword">Finally</span>&#123;&#125;</span><br><span class="line">    &#125;<span class="keyword">While</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">Function</span> New-Shortcut()&#123; </span><br><span class="line">    <span class="comment"># used to create a shortcut, in this script, this is mainly used to create shortcut for original old and new csv file</span></span><br><span class="line">    [CmdletBinding()]param(</span><br><span class="line">        [Parameter(Mandatory=<span class="literal">$True</span>)]</span><br><span class="line">        [string]<span class="variable">$shortcut_path</span>,</span><br><span class="line">        [string]<span class="variable">$target_path</span></span><br><span class="line">    )</span><br><span class="line">    <span class="variable">$WshShell</span> = <span class="built_in">New-Object</span> -comObject WScript.Shell</span><br><span class="line">    <span class="variable">$shortcut</span> = <span class="variable">$WshShell</span>.CreateShortcut(<span class="variable">$shortcut_path</span>)</span><br><span class="line">    <span class="variable">$shortcut</span>.TargetPath = <span class="variable">$target_path</span></span><br><span class="line">    <span class="variable">$shortcut</span>.Save()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">Function</span> Exit-Script(<span class="variable">$error_info</span>,<span class="variable">$log_file</span>,<span class="variable">$compare_file_path</span>)&#123;</span><br><span class="line">    <span class="keyword">If</span>( ![string]::IsNullOrWhiteSpace(<span class="variable">$error_info</span> ) )&#123;</span><br><span class="line">        <span class="built_in">write-log</span> Error <span class="variable">$error_info</span> <span class="variable">$log_file</span> -print_to_console</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;<span class="built_in">write-host</span> -fore yellow <span class="string">"The compare file is --&gt; '<span class="variable">$compare_file_path</span>'"</span>&#125;</span><br><span class="line">    <span class="keyword">exit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>New-Shortcut用到的是调用vbscript的功能，这里大家先知道这么用，以后会详细讲解</li>
<li>[string]::IsNullOrWhiteSpace($error_info )是.NET的方法，用来判断一个string是否为null或者只有空白字符。</li>
</ul>
<h4 id="现在我们已经有了2个csv-file，在正式比较之前我们需要初始化一下变量和预处理："><a href="#现在我们已经有了2个csv-file，在正式比较之前我们需要初始化一下变量和预处理：" class="headerlink" title="现在我们已经有了2个csv file，在正式比较之前我们需要初始化一下变量和预处理："></a>现在我们已经有了2个csv file，在正式比较之前我们需要初始化一下变量和预处理：</h4><ul>
<li>如果用户没有提供compare_path，那么我们就在当前目录创建一个名为compare的子目录存放结果。</li>
<li>在确定了compare path之后我们用旧的csv加上新的csv名字作为最终compare result csv name</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$this_path</span>=<span class="variable">$PSScriptRoot</span> ; <span class="variable">$old_file_info</span>=gi <span class="variable">$old_csv</span> ; <span class="variable">$new_file_info</span>=gi <span class="variable">$new_csv</span></span><br><span class="line"><span class="variable">$old_file_basename</span>=<span class="variable">$old_file_info</span>.basename ; <span class="variable">$new_file_basename</span>=<span class="variable">$new_file_info</span>.basename</span><br><span class="line"><span class="keyword">If</span>( !<span class="variable">$PSBoundParameters</span>.ContainsKey(<span class="string">'compare_path'</span>) )&#123; <span class="comment"># $PSBoundParameters is the list of all the parameter names that pass to the script</span></span><br><span class="line">    <span class="variable">$compare_path</span>=<span class="string">"<span class="variable">$this_path</span>\compare"</span>                                            <span class="comment"># the folder to store compare results file</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$compare_result_csv</span>=<span class="string">"<span class="variable">$compare_path</span>\<span class="variable">$old_file_basename</span>-<span class="variable">$new_file_basename</span>-compare.csv"</span>  <span class="comment"># the csv to store compare results data</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果<strong>compare result csv</strong>已经存在或者<strong>新旧csv</strong>名字相同，那么我们都退出脚本，不再继续执行下去</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!(<span class="built_in">test-path</span> <span class="variable">$compare_path</span> -ea <span class="number">4</span>))&#123;                                           <span class="comment"># if the the compare folder</span></span><br><span class="line">    <span class="built_in">new-item</span> -ItemType Directory -path <span class="variable">$compare_path</span> -Force -ea <span class="number">0</span>|<span class="built_in">out-null</span>      <span class="comment"># not exists, create it</span></span><br><span class="line">&#125;<span class="keyword">elseif</span>(<span class="built_in">test-path</span> <span class="variable">$compare_result_csv</span>)&#123;                                         <span class="comment"># if compare result csv already exists</span></span><br><span class="line">    Exit-Script <span class="string">''</span> <span class="variable">$log_file</span> <span class="variable">$compare_result_csv</span>                                 <span class="comment"># then exit the script casue the 2 csvs have already been compared</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$log_file</span> = <span class="string">"<span class="variable">$compare_path</span>\out.log"</span>                                             <span class="comment"># log to store running info</span></span><br><span class="line"><span class="keyword">If</span>( <span class="variable">$old_file_info</span>.Name <span class="nomarkup">-eq</span> <span class="variable">$new_file_info</span>.Name )&#123;                              <span class="comment"># exit if they are the same file</span></span><br><span class="line">    Exit-Script <span class="string">"The 2 compared csv files`r`n<span class="variable">$old_csv</span>`r`n<span class="variable">$new_csv</span>`r`nhave the same name!"</span> <span class="variable">$log_file</span> <span class="variable">$compare_result_csv</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来获取各个csv的表头（上一篇讲过），如果表头不一致（名字，个数和顺序都相同才为一致），则退出脚本</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&lt;------------------------------------------------------------------------------# load 2 csv content and the csv header</span></span><br><span class="line"><span class="variable">$old_csv_content</span>=(ipcsv <span class="variable">$old_csv</span>) ; <span class="variable">$old_header</span>=<span class="variable">$old_csv_content</span>[<span class="number">0</span>].psobject.Properties | % &#123; <span class="variable">$_</span>.Name &#125;</span><br><span class="line"><span class="variable">$new_csv_content</span>=(ipcsv <span class="variable">$new_csv</span>) ; <span class="variable">$new_header</span>=<span class="variable">$new_csv_content</span>[<span class="number">0</span>].psobject.Properties | % &#123; <span class="variable">$_</span>.Name &#125;</span><br><span class="line"><span class="keyword">If</span>( <span class="variable">$old_header</span>.count <span class="nomarkup">-ne</span> <span class="variable">$new_header</span>.count)&#123;                                   <span class="comment"># exit if the 2 csv files header counts not equal</span></span><br><span class="line">    Exit-Script <span class="string">"The 2 compared csv files`r`n<span class="variable">$old_csv</span>`r`n<span class="variable">$new_csv</span>`r`nhave different headers!"</span> <span class="variable">$log_file</span> <span class="variable">$compare_result_csv</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">For</span>( <span class="variable">$n</span>=<span class="number">0</span>; <span class="variable">$n</span> <span class="nomarkup">-lt</span> <span class="variable">$old_header</span>.count; <span class="variable">$n</span>++ )&#123;                                <span class="comment"># exit if the 2 csv files header names not same</span></span><br><span class="line">        <span class="keyword">If</span>( <span class="variable">$old_header</span>[<span class="variable">$n</span>] <span class="nomarkup">-ne</span> <span class="variable">$new_header</span>[<span class="variable">$n</span>] )&#123;</span><br><span class="line">            Exit-Script <span class="string">"The 2 compared csv files`r`n<span class="variable">$old_csv</span>`r`n<span class="variable">$new_csv</span>`r`nhave different headers or same header names but different header sequence!"</span> <span class="variable">$log_file</span> <span class="variable">$compare_result_csv</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在compare folder下创建原始csv的快捷方式，这样不用把原始文件copy过来，节省磁盘空间。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">New-Shortcut <span class="string">"<span class="variable">$compare_path</span>\old-$(<span class="variable">$old_file_info</span>.basename).lnk"</span> <span class="variable">$old_csv</span></span><br><span class="line">New-Shortcut <span class="string">"<span class="variable">$compare_path</span>\new-$(<span class="variable">$new_file_info</span>.basename).lnk"</span> <span class="variable">$new_csv</span></span><br></pre></td></tr></table></figure>

<h3 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h3><p>目标结果如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Action User Role    </span><br><span class="line">------ ---- ----    </span><br><span class="line">Revoke alex upload  </span><br><span class="line">Grant  alex delete  </span><br><span class="line">Revoke jim  download</span><br><span class="line">Grant  jim  upload</span><br></pre></td></tr></table></figure>

<p>我们直接按照刚才上面所说的比较的话会没有任何内容显示出来</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\SPPS&gt; compare <span class="variable">$old_csv_content</span> <span class="variable">$new_csv_content</span> <span class="comment"># nothing output</span></span><br></pre></td></tr></table></figure>

<p>针对csv的比较，我们需要提供比较的属性，也就是表头。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\SPPS&gt; compare <span class="variable">$old_csv_content</span> <span class="variable">$new_csv_content</span> -Property <span class="variable">$old_header</span></span><br><span class="line">User Role     SideIndicator</span><br><span class="line">---- ----     -------------</span><br><span class="line">alex delete   =&gt;           </span><br><span class="line">jim  upload   =&gt;           </span><br><span class="line">alex upload   &lt;=           </span><br><span class="line">jim  download &lt;=</span><br></pre></td></tr></table></figure>

<p>可以看到结果了，但是离最终的样式还有一段距离，接下来我们需要用到select-object来调整样式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">compare <span class="variable">$old_csv_content</span> <span class="variable">$new_csv_content</span> -Property <span class="variable">$old_header</span> `</span><br><span class="line">|select @&#123;n=<span class="string">"Action"</span>;e=&#123;<span class="keyword">if</span>(<span class="variable">$_</span>.SideIndicator <span class="nomarkup">-eq</span> <span class="string">"=&gt;"</span>)&#123;<span class="string">"Grant"</span>&#125;<span class="keyword">else</span>&#123;<span class="string">"Revoke"</span>&#125;&#125;&#125;,User,role</span><br><span class="line"><span class="comment"># below is the compare output </span></span><br><span class="line"></span><br><span class="line">Action User Role    </span><br><span class="line">------ ---- ----    </span><br><span class="line">Grant  alex delete  </span><br><span class="line">Grant  jim  upload  </span><br><span class="line">Revoke alex upload  </span><br><span class="line">Revoke jim  download</span><br></pre></td></tr></table></figure>

<p>我们看到效果已经是和我们需要的一样了，但是这就结束了吗，细心的小伙伴可能已经发现了，这里select筛选的时候我们写死了<code>User</code>,<code>role</code>，但是显然不可能每次比较csv的时候都是同样的表头，那像下面这样用变量<code>$old_header</code>呢？</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">compare <span class="variable">$old_csv_content</span> <span class="variable">$new_csv_content</span> -Property <span class="variable">$old_header</span> `</span><br><span class="line">|select @&#123;n=<span class="string">"Action"</span>;e=&#123;<span class="keyword">if</span>(<span class="variable">$_</span>.SideIndicator <span class="nomarkup">-eq</span> <span class="string">"=&gt;"</span>)&#123;<span class="string">"Grant"</span>&#125;<span class="keyword">else</span>&#123;<span class="string">"Revoke"</span>&#125;&#125;&#125;,<span class="variable">$old_header</span></span><br><span class="line"><span class="comment"># below is the output </span></span><br><span class="line">select : 无法将 System.Object[] 转换为以下类型之一 &#123;System.String, System.Management.Automation.ScriptBlock&#125;。</span><br><span class="line">所在位置 行:<span class="number">1</span> 字符: <span class="number">65</span></span><br><span class="line">+ ... <span class="variable">$old_header</span>|select @&#123;n=<span class="string">"Action"</span>;e=&#123;<span class="keyword">if</span>(<span class="variable">$_</span>.SideIndicator <span class="nomarkup">-eq</span> <span class="string">"=&gt;"</span>)&#123;<span class="string">"Gra ...</span></span><br><span class="line"><span class="string">+                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span><br><span class="line"><span class="string">    + CategoryInfo          : InvalidArgument: (:) [Select-Object]，NotSupportedException</span></span><br><span class="line"><span class="string">    + FullyQualifiedErrorId : DictionaryKeyUnknownType,Microsoft.PowerShell.Commands.SelectObjectCommand</span></span><br></pre></td></tr></table></figure>

<p>很不幸，这样居然不行，这里我们需要将自定义的哈希表保存到一个数组然后再和后面的表头数组组合成一个完整数组</p>
<ul>
<li>保存哈希表到数组： @(@{n=”Action”;e={if($_.SideIndicator -eq “=&gt;”){“Grant”}else{“Revoke”}}})</li>
<li>和表头数组组合成一个完整数组： (@(@{n=”Action”;e={if($_.SideIndicator -eq “=&gt;”){“Grant”}else{“Revoke”}}})+$old_header)</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">compare <span class="variable">$old_csv_content</span> <span class="variable">$new_csv_content</span> -Property <span class="variable">$old_header</span> `</span><br><span class="line">|select (@(@&#123;n=<span class="string">"Action"</span>;e=&#123;<span class="keyword">if</span>(<span class="variable">$_</span>.SideIndicator <span class="nomarkup">-eq</span> <span class="string">"=&gt;"</span>)&#123;<span class="string">"Grant"</span>&#125;<span class="keyword">else</span>&#123;<span class="string">"Revoke"</span>&#125;&#125;&#125;)+<span class="variable">$old_header</span>)</span><br><span class="line"><span class="comment"># below is the output </span></span><br><span class="line"></span><br><span class="line">Action User Role    </span><br><span class="line">------ ---- ----    </span><br><span class="line">Grant  alex delete  </span><br><span class="line">Grant  jim  upload  </span><br><span class="line">Revoke alex upload  </span><br><span class="line">Revoke jim  download</span><br></pre></td></tr></table></figure>

<p>OK,是我们想要的结果，而且这次我们用了表头变量，所以针对任何形式的csv都可以这样比较了，那么保存比较结果到csv中：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&lt;------------------------------------------------------------------------------------# start to compare the 2 csv content with formated column name</span></span><br><span class="line"><span class="keyword">if</span>((<span class="variable">$action_result</span>=<span class="built_in">compare-object</span> <span class="variable">$old_csv_content</span> <span class="variable">$new_csv_content</span> -Property <span class="variable">$old_header</span>|select (@(@&#123;n=<span class="string">"Action"</span>;e=&#123;<span class="keyword">if</span>(<span class="variable">$_</span>.SideIndicator <span class="nomarkup">-eq</span> <span class="string">"=&gt;"</span>)&#123;<span class="string">"Grant"</span>&#125;<span class="keyword">else</span>&#123;<span class="string">"Revoke"</span>&#125;&#125;&#125;)+<span class="variable">$old_header</span>)) <span class="nomarkup">-ne</span> <span class="literal">$null</span>)&#123;</span><br><span class="line">    <span class="variable">$action_result</span>|<span class="built_in">Export-Csv</span> -Path   -UseCulture -NoTypeInformation -Encoding UTF8 -Force -ea <span class="number">1</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">write-log</span> Normal <span class="string">"No difference between 2 csv files`r`n<span class="variable">$old_csv</span>`r`n<span class="variable">$new_csv</span>"</span> <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br><span class="line">Exit-Script <span class="string">''</span> <span class="variable">$log_file</span> <span class="variable">$compare_result_csv</span></span><br><span class="line">```	</span><br><span class="line"></span><br><span class="line"><span class="comment">### 验证脚本的完整功能性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 相同名字</span></span><br><span class="line"></span><br><span class="line">``` powershell</span><br><span class="line">C:\Users\SPPS&gt; .\compare-csv.ps1 .\same_name.csv ..\same_name.csv</span><br><span class="line"></span><br><span class="line">The <span class="number">2</span> compared csv files</span><br><span class="line">.\same_name.csv</span><br><span class="line">..\same_name.csv</span><br><span class="line">have the same name!</span><br></pre></td></tr></table></figure>

<h4 id="表头不对"><a href="#表头不对" class="headerlink" title="表头不对"></a>表头不对</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&lt;---------------- same header count, differ header name</span></span><br><span class="line">C:\Users\SPPS&gt; ipcsv .\error1.csv</span><br><span class="line"></span><br><span class="line">User1 Role    </span><br><span class="line">----- ----    </span><br><span class="line">alex  upload  </span><br><span class="line">tom   delete  </span><br><span class="line">jim   download</span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; ipcsv .\error2.csv</span><br><span class="line"></span><br><span class="line">User2 Role  </span><br><span class="line">----- ----  </span><br><span class="line">alex  delete</span><br><span class="line">tom   delete</span><br><span class="line">jim   upload</span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; .\compare-csv.ps1 .\error1.csv .\error2.csv </span><br><span class="line"></span><br><span class="line">The <span class="number">2</span> compared csv files</span><br><span class="line">.\error1.csv</span><br><span class="line">.\error2.csv</span><br><span class="line">have different headers or same header names but different header sequence!</span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;-------------------- different header</span></span><br><span class="line">C:\Users\SPPS&gt; ipcsv .\error1.csv</span><br><span class="line"></span><br><span class="line">Role     User</span><br><span class="line">----     ----</span><br><span class="line">upload   alex</span><br><span class="line">delete   tom </span><br><span class="line">download jim </span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; ipcsv .\error2.csv</span><br><span class="line"></span><br><span class="line">User Role   Domain</span><br><span class="line">---- ----   ------</span><br><span class="line">alex delete nam   </span><br><span class="line">tom  delete apac  </span><br><span class="line">jim  upload eur   </span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; .\compare-csv.ps1 .\error1.csv .\error2.csv</span><br><span class="line"></span><br><span class="line">The <span class="number">2</span> compared csv files</span><br><span class="line">.\error1.csv</span><br><span class="line">.\error2.csv</span><br><span class="line">have different headers!</span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;------------- same header name and count, but differ sequence</span></span><br><span class="line">C:\Users\SPPS&gt; ipcsv .\error1.csv</span><br><span class="line"></span><br><span class="line">Role     User</span><br><span class="line">----     ----</span><br><span class="line">upload   alex</span><br><span class="line">delete   tom </span><br><span class="line">download jim </span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; ipcsv .\error2.csv</span><br><span class="line"></span><br><span class="line">User Role  </span><br><span class="line">---- ----  </span><br><span class="line">alex delete</span><br><span class="line">tom  delete</span><br><span class="line">jim  upload</span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; .\compare-csv.ps1 .\error1.csv .\error2.csv</span><br><span class="line"></span><br><span class="line">The <span class="number">2</span> compared csv files</span><br><span class="line">.\error1.csv</span><br><span class="line">.\error2.csv</span><br><span class="line">have different headers or same header names but different header sequence!</span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt;</span><br></pre></td></tr></table></figure>

<h4 id="正常比较和比较的结果"><a href="#正常比较和比较的结果" class="headerlink" title="正常比较和比较的结果"></a>正常比较和比较的结果</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\SPPS&gt; .\compare-csv.ps1 .\after_content.csv .\before_content.csv</span><br><span class="line">The compare file is --&gt; <span class="string">'C:\Users\SPPS\compare\after_content-before_content-compare.csv'</span></span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; ls .\compare</span><br><span class="line"></span><br><span class="line">目录: C:\Users\SPPS\compare</span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">-a----        <span class="number">5</span>/<span class="number">12</span>/<span class="number">2018</span>   <span class="number">2</span>:<span class="number">56</span> PM            <span class="number">129</span> after_content-before_content-compare.csv</span><br><span class="line">-a----        <span class="number">5</span>/<span class="number">12</span>/<span class="number">2018</span>   <span class="number">2</span>:<span class="number">56</span> PM            <span class="number">323</span> new-before_content.lnk</span><br><span class="line">-a----        <span class="number">5</span>/<span class="number">12</span>/<span class="number">2018</span>   <span class="number">2</span>:<span class="number">56</span> PM            <span class="number">317</span> old-after_content.lnk</span><br><span class="line"></span><br><span class="line">C:\Users\SPPS&gt; ipcsv C:\Users\SPPS\compare\after_content-before_content-compare.csv</span><br><span class="line"></span><br><span class="line">Action User Role    </span><br><span class="line">------ ---- ----    </span><br><span class="line">Grant  alex upload  </span><br><span class="line">Grant  jim  download</span><br><span class="line">Revoke alex delete  </span><br><span class="line">Revoke jim  upload</span><br></pre></td></tr></table></figure>

<h4 id="再次比较相同csv"><a href="#再次比较相同csv" class="headerlink" title="再次比较相同csv"></a>再次比较相同csv</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\SPPS&gt; .\compare-csv.ps1 .\after_content.csv .\before_content.csv</span><br><span class="line"></span><br><span class="line">The <span class="number">2</span> cvsv files have already been compared before</span><br><span class="line">The compare file is --&gt; <span class="string">'C:\Users\SPPS\compare\after_content-before_content-compare.csv'</span></span><br></pre></td></tr></table></figure>

<p>OK, 跑一遍可以解决我们预期遇到的各种问题，完整脚本和csv file在我的码云上<a href="https://gitee.com/chaoyuew/powershell/tree/feature/wechat/SPPS25，预计下一篇讲合并多个csv文件。" target="_blank" rel="noopener">https://gitee.com/chaoyuew/powershell/tree/feature/wechat/SPPS25，预计下一篇讲合并多个csv文件。</a></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">超速蜗牛</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://chaoyuew.gitee.io/WPS-25-Advanced-Compare-Csv.html">https://chaoyuew.gitee.io/WPS-25-Advanced-Compare-Csv.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chaoyuew.gitee.io">超速蜗牛的博客</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/WPS-26-Advanced-Merge-Csv.html"><i class="fas fa-angle-left">&nbsp;</i><span>Windows PowerShell进阶(26) 合并csv</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/WPS-24-Advanced-PSCustomObject.html"><span>Windows PowerShell进阶(24) PSCustomObject</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2019 By 超速蜗牛</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>