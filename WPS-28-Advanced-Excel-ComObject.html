<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Windows PowerShell进阶(28) Excel ComObject"><meta name="keywords" content="进阶,Excel,ComObject"><meta name="author" content="超速蜗牛,undefined"><meta name="copyright" content="超速蜗牛"><title>Windows PowerShell进阶(28) Excel ComObject【超速蜗牛的博客】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"AOHMI93W80","apiKey":"3f74c7e8113768c69c3eedfd6540618f","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#拆解步骤"><span class="toc-number">1.</span> <span class="toc-text">拆解步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化参数，函数等"><span class="toc-number">1.1.</span> <span class="toc-text">初始化参数，函数等</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建Excel-COM-对象示例"><span class="toc-number">1.2.</span> <span class="toc-text">创建Excel COM 对象示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启用允许使用宏"><span class="toc-number">1.3.</span> <span class="toc-text">启用允许使用宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#准备宏"><span class="toc-number">1.4.</span> <span class="toc-text">准备宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行宏并保存"><span class="toc-number">1.5.</span> <span class="toc-text">运行宏并保存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#退出清理"><span class="toc-number">1.6.</span> <span class="toc-text">退出清理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#完整运行验证"><span class="toc-number">1.7.</span> <span class="toc-text">完整运行验证</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#MacroSource-”Template”"><span class="toc-number">1.7.1.</span> <span class="toc-text">$MacroSource=”Template”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MacroSource-”ModuleFile”"><span class="toc-number">1.7.2.</span> <span class="toc-text">$MacroSource=”ModuleFile”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MacroSource-”VBFile”"><span class="toc-number">1.7.3.</span> <span class="toc-text">$MacroSource=”VBFile”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结语"><span class="toc-number">2.</span> <span class="toc-text">结语</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">超速蜗牛</div><div class="author-info-description">Learn PowerShell.</div><div class="links-buttons"><a class="links-button button-hover" href="https://gitee.com/chaoyuew" target="_blank">Gitee<i class="icon-dot bg-color6"></i></a><a class="links-button button-hover" href="mailto:348001390@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color4"></i></a><a class="links-button button-hover" href="tencent://message/?uin=348001390&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color3"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">30</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">37</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">2</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">超速蜗牛的博客</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">Windows PowerShell进阶(28) Excel ComObject</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-08-28 | 更新于 2019-08-29</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/powershell/">powershell</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/进阶/">进阶</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/Excel/">Excel</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/ComObject/">ComObject</a></div></div></div><div class="main-content"><p>本文首发于本人公众号SPPS178,现搬运过来,较原文有所改动.</p>
<p>这篇接着讲csv的相关操作，不过是要用powershell调用excel程序，然后执行宏macro来实现。需要小伙伴们有一点VBA语言基础，没有的话可以先去简单学下VBA，了解下基本的语法即可。或者这篇你完全当做兴趣了解看下也行， 心里有个数，以后有会遇到这块的需求时可以再回来看。这个网上资源很多，我自己百度盘现有一个资源，原微信公众号上面的链接已经失效,但是今天创建分享链接后,链接却一直提示失效,.所以这块大家自己找找资源吧(比如B站上就一大堆<a href="https://search.bilibili.com/all?keyword=excel%20vba&amp;from_source=banner_search" target="_blank" rel="noopener">https://search.bilibili.com/all?keyword=excel%20vba&amp;from_source=banner_search</a>)</p>
<a id="more"></a>

<p>我们可以用录制宏来实现VBA主框架，剩下的需要细微修改下，比如下面的A1,A2之类的在实际开发过程中肯定得用变量来表示。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6ftj00xd7g30ly0f8u0x.gif"><br><div>28-1 录制宏并执行</div></center>

<p>我们可以看到录制宏的源代码是VBA语言写的，所以大家要多少有点VBA基础。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Sub Test()</span><br><span class="line">    Range(&quot;A1&quot;).Select</span><br><span class="line">    ActiveCell.FormulaR1C1 = &quot;name&quot;</span><br><span class="line">    Range(&quot;A2&quot;).Select</span><br><span class="line">    ActiveCell.FormulaR1C1 = &quot;alex&quot;</span><br><span class="line">    Range(&quot;A3&quot;).Select</span><br><span class="line">    ActiveCell.FormulaR1C1 = &quot;tom&quot;</span><br><span class="line">    Range(&quot;A4&quot;).Select</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>

<p>下面演示的是我们希望powershell脚本最终实现的效果（录的时候最后合并完的时候第6行多余的表头忘了删了），这个例子里面我们有2个csv file</p>
<ul>
<li>harware.csv，系统的信息：类似分辨率，核心数</li>
<li>startup.csv，开始文件夹里面的文件，包含快捷方式和其源文件路径</li>
</ul>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6ftl08x3ig31bw0eokjl.gif"><br><div>28-2 合并CSV演示</div></center>

<p>我们可以看到原始录制的宏源码还是很粗糙的，需要额外修改下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Sub CombineCsv()</span><br><span class="line">    Windows(&quot;harware.csv&quot;).Activate</span><br><span class="line">    Range(&quot;A1:E3&quot;).Select</span><br><span class="line">    Selection.Copy</span><br><span class="line">    Windows(&quot;工作簿1&quot;).Activate</span><br><span class="line">    Selection.PasteSpecial Paste:=xlPasteAll, Operation:=xlNone, SkipBlanks:= _</span><br><span class="line">        False, Transpose:=True</span><br><span class="line">    Windows(&quot;startup.csv&quot;).Activate</span><br><span class="line">    Range(&quot;A1:D3&quot;).Select</span><br><span class="line">    Application.CutCopyMode = False</span><br><span class="line">    Selection.Copy</span><br><span class="line">    Windows(&quot;工作簿1&quot;).Activate</span><br><span class="line">    Range(&quot;A6&quot;).Select</span><br><span class="line">    Selection.PasteSpecial Paste:=xlPasteAll, Operation:=xlNone, SkipBlanks:= _</span><br><span class="line">        False, Transpose:=True</span><br><span class="line">    Range(&quot;B1:C9&quot;).Select</span><br><span class="line">    Application.CutCopyMode = False</span><br><span class="line">    Selection.Cut Destination:=Range(&quot;C1:D9&quot;)</span><br><span class="line">    Range(&quot;A1:A9&quot;).Select</span><br><span class="line">    Selection.TextToColumns Destination:=Range(&quot;A1&quot;), DataType:=xlDelimited, _</span><br><span class="line">        TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, _</span><br><span class="line">        Semicolon:=False, Comma:=False, Space:=False, Other:=True, OtherChar _</span><br><span class="line">        :=&quot;/&quot;, FieldInfo:=Array(Array(1, 1), Array(2, 1)), TrailingMinusNumbers:=True</span><br><span class="line">    Range(&quot;A1&quot;).Select</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>

<p>再次强调下，这是powershell的相关文章，所以我不会过多地解释别的语言的使用，还请大家见谅。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Sub CopyCsvFile(ByVal csvFile)</span><br><span class="line">    &apos;----------------------- open source csv file  -----------------------</span><br><span class="line">    Workbooks.Open Filename:=csvFile</span><br><span class="line">    last_row = Cells(Rows.Count, 1).End(xlUp).Row &apos;get last row of opened csv file</span><br><span class="line">    last_column = Cells(1, Columns.Count).End(xlToLeft).Column  &apos;get last column of opened csv file</span><br><span class="line">    ActiveSheet.Range(Cells(1, 1), Cells(last_row, last_column)).Copy   &apos; copy the range data from opened csv file</span><br><span class="line">    &apos;----------------------- active current xlsm file --------------------</span><br><span class="line">    ThisWorkbook.Activate</span><br><span class="line">    last_row = Cells(Rows.Count, 1).End(xlUp).Row   &apos;get last empty row of current xlsm file</span><br><span class="line">    If Not IsEmpty(Cells(last_row, 1)) Then</span><br><span class="line">        last_row = last_row + 1</span><br><span class="line">    End If</span><br><span class="line">    head_row = last_row &apos;the head row of the to be copied range data</span><br><span class="line">    Cells(last_row, 1).Select</span><br><span class="line">    &apos;----- paste the data from previous csv file into this xlsm file -----</span><br><span class="line">    If Not csvFile Like &quot;*hpca.csv&quot; And Not csvFile Like &quot;*ie.csv&quot; Then &apos; for hpca and ie, no need to transpose row and column</span><br><span class="line">        Selection.PasteSpecial Paste:=xlPasteAll, Operation:=xlNone, SkipBlanks:= _</span><br><span class="line">            False, Transpose:=True</span><br><span class="line">        last_row = Cells(Rows.Count, 1).End(xlUp).Row   &apos;get last row of current xlsm file after pasting data</span><br><span class="line">        Range(&quot;B&quot; &amp; head_row &amp; &quot;:B&quot; &amp; last_row).Select &apos;move colum B&lt;-&gt;... to right after colum A so that split colum A won&apos;t overwrite them</span><br><span class="line">            Selection.Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove</span><br><span class="line">        Range(&quot;A&quot; &amp; head_row &amp; &quot;:A&quot; &amp; last_row).Select &apos; split colum A</span><br><span class="line">        Selection.TextToColumns Destination:=Range(&quot;A&quot; &amp; head_row), DataType:=xlDelimited, _</span><br><span class="line">            TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, _</span><br><span class="line">            Semicolon:=False, Comma:=False, Space:=False, Other:=True, OtherChar _</span><br><span class="line">            :=&quot;/&quot;, FieldInfo:=Array(Array(1, 1), Array(2, 1)), TrailingMinusNumbers:=True</span><br><span class="line">    Else</span><br><span class="line">        Selection.PasteSpecial Paste:=xlPasteAll, Operation:=xlNone, SkipBlanks:= _</span><br><span class="line">            False, Transpose:=False</span><br><span class="line">    End If</span><br><span class="line">    If head_row &gt; 1 Then &apos; remove table header if it&apos;s not the first data to be copied</span><br><span class="line">        Rows(head_row &amp; &quot;:&quot; &amp; head_row).Select</span><br><span class="line">        Selection.Delete Shift:=xlUp</span><br><span class="line">    End If</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>

<p>接下来我们一步一步用powershell来实现。</p>
<h3 id="拆解步骤"><a href="#拆解步骤" class="headerlink" title="拆解步骤"></a>拆解步骤</h3><h4 id="初始化参数，函数等"><a href="#初始化参数，函数等" class="headerlink" title="初始化参数，函数等"></a>初始化参数，函数等</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[CmdletBinding(DefaultParameterSetName=<span class="string">'Folder'</span>)]param(</span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Folder'</span>)]</span><br><span class="line">    [ValidateScript(&#123;<span class="built_in">test-path</span> <span class="variable">$_</span>&#125;)]</span><br><span class="line">    [string]<span class="variable">$source_csv_folder</span>=<span class="variable">$PSScriptRoot</span>,     <span class="comment"># the folder contains source csv files, default is current folder</span></span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Array'</span>)]</span><br><span class="line">    [ValidateNotNullOrEmpty()]</span><br><span class="line">    [array]<span class="variable">$source_csv_files</span>,                      <span class="comment"># the source csv files to be combined into one csv file</span></span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Folder'</span>)]</span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Array'</span>)]           </span><br><span class="line">    [ValidateSet(<span class="string">"Template"</span>,<span class="string">"ModuleFile"</span>,<span class="string">"VBFile"</span>)] <span class="comment"># the macro source type</span></span><br><span class="line">    [string]<span class="variable">$MacroSource</span>=<span class="string">"Template"</span>,</span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Folder'</span>)]</span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Array'</span>)]           </span><br><span class="line">    [string]<span class="variable">$result_file</span>=<span class="string">"<span class="variable">$PSScriptRoot</span>\result\Combine-CsvWithMacro.csv"</span>,</span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Folder'</span>)]</span><br><span class="line">    [Parameter(ParameterSetName=<span class="string">'Array'</span>)]           </span><br><span class="line">    [string]<span class="variable">$log_file</span>=<span class="string">"<span class="variable">$PSScriptRoot</span>\result\Combine-CsvWithMacro.log"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="创建Excel-COM-对象示例"><a href="#创建Excel-COM-对象示例" class="headerlink" title="创建Excel COM 对象示例"></a>创建Excel COM 对象示例</h4><p>powershell虽然强大，但并不是万能的，对Windows的有些操作还需要其他的接口来实现，其中一种就叫做<code>COM(Component Object Model)</code>，简单来讲就是其他应用对外开放的一个接口，可以让别的语言来对其交互使用，英语好的可以看下面微软官方介绍：</p>
<blockquote>
<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms694363(v=vs.85).aspx" target="_blank" rel="noopener">The Component Object Model</a><br><a href="https://docs.microsoft.com/en-us/powershell/scripting/getting-started/cookbooks/creating-.net-and-com-objects--new-object-?view=powershell-6" target="_blank" rel="noopener">Creating .NET and COM Objects (New-Object)</a></p>
</blockquote>
<p>那么对于excel我们就可以用下面命令来获取它的一个对象示例。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$excel</span> = <span class="built_in">new-object</span> -comobject excel.application</span><br><span class="line"><span class="variable">$excel</span>.DisplayAlerts=<span class="literal">$false</span> <span class="comment"># suppress any warning message</span></span><br><span class="line"><span class="comment"># In default, the excel will no show, if you set this to $true, the excel</span></span><br><span class="line"><span class="comment"># will show during the running progress, however it will much lower script running speed</span></span><br><span class="line"><span class="comment"># $excel.Visible=$true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>new-object: 新建对象</li>
<li>-comobject： 对象类型</li>
<li>excel.application： 对象名称，C#中叫做命名空间（namespace）</li>
</ul>
<p>一些常用的COM接口可以在<a href="https://gitee.com/chaoyuew/tools/blob/master/Windows%20PowerShell%20Cookbook,Third%20Edition.pdf" target="_blank" rel="noopener">Windows PowerShell Cookbook, Third Edition.pdf</a>这本书的附录H（959页）中找到，基本能满足日常使用需求了,更加完整的可以看下这篇SO的问答<a href="https://stackoverflow.com/questions/660319/where-can-i-find-all-of-the-com-objects-that-can-be-created-in-powershell" target="_blank" rel="noopener">Where can I find all of the COM objects that can be created in Powershell?</a>，根据电脑不同，有几百到上千不等。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6fts4cl34j30iz0otgo0.jpg"><br><div>28-3 COM Object</div></center>

<h4 id="启用允许使用宏"><a href="#启用允许使用宏" class="headerlink" title="启用允许使用宏"></a>启用允许使用宏</h4><center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6fttctpjdj309v043jr8.jpg"><br><div>28-4 宏被禁用</div></center>

<p>有的电脑比如公司的可能默认情况下是关闭可使用宏的功能的，所以为了保险起见我们都强制的把它enable，这个是通过修改<code>注册表</code>来完成的，以后会专门有篇幅讲针对注册表的操作。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ItemProperty</span> -Path <span class="string">"HKCU:\Software\Microsoft\Office\$(<span class="variable">$excel</span>.Version)\Excel\Security"</span> -Name AccessVBOM -Value <span class="number">1</span> -Force | <span class="built_in">Out-Null</span></span><br><span class="line"><span class="built_in">New-ItemProperty</span> -Path <span class="string">"HKCU:\Software\Microsoft\Office\$(<span class="variable">$excel</span>.Version)\Excel\Security"</span> -Name VBAWarnings  -Value <span class="number">1</span> -Force | <span class="built_in">Out-Null</span></span><br></pre></td></tr></table></figure>

<h4 id="准备宏"><a href="#准备宏" class="headerlink" title="准备宏"></a>准备宏</h4><p>目前我知道有3个方法来准备宏（依次代码量由少到多）：</p>
<ul>
<li>打开提前保存宏的excel template文件，一般后缀是.xlsm</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$workbook</span> = <span class="variable">$Excel</span>.Workbooks.open(<span class="string">"c:\temp\template.xlsm"</span>) <span class="comment"># 打开excel文件</span></span><br></pre></td></tr></table></figure>

<ul>
<li>新建工作表，导入单独保存好的Module文件，一般后缀是.bas</li>
</ul>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6ftwqawpkj30yl0hx3zk.jpg"><br><div>28-5 导出宏</div></center>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$workbook</span> = <span class="variable">$Excel</span>.Workbooks.add() <span class="comment"># add a new workbook</span></span><br><span class="line"><span class="variable">$workbook</span>.VBProject.VBComponents.Import(<span class="string">"C:\temp\CopyCsvFile.bas"</span>) <span class="comment"># 导入module文件，其包含有宏</span></span><br></pre></td></tr></table></figure>

<ul>
<li>新建工作表，新建module，写入macro code, 从File或者从String</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$workbook</span> = <span class="variable">$Excel</span>.Workbooks.add() <span class="comment"># add a new workbook</span></span><br><span class="line"><span class="comment"># add a standard module</span></span><br><span class="line"><span class="variable">$xlmodule</span> =<span class="variable">$workbook</span>.VBProject.VBComponents.Add([Microsoft.Vbe.Interop.vbext_ComponentType]::vbext_ct_StdModule) </span><br><span class="line"><span class="variable">$xlmodule</span>.Name = <span class="string">"Module1"</span> <span class="comment"># set module name，make sure not same to macro enter function name</span></span><br><span class="line"><span class="variable">$xlmodule</span>.CodeModule.AddFromFile(<span class="string">"C:\temp\CopyCsvFile.vb"</span>) <span class="comment"># add module code from file</span></span><br><span class="line"><span class="variable">$macro_string</span>=<span class="string">'@</span></span><br><span class="line"><span class="string">Sub CopyCsvFile()</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"><span class="string">' VBA code goes here</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"><span class="keyword">End</span> Sub</span><br><span class="line"><span class="string">@'</span></span><br><span class="line"><span class="string">$xlmodule.CodeModule.AddFromString($macro_string) # add module code from string</span></span><br></pre></td></tr></table></figure>

<p>第3个我跑的时候出了点小问题,在试图添加module的时候报错了。还有就是确保module name不要和宏的入口函数名字一致，不然报错<font color="yellow">无法运行“CopyCsvFile”宏。可能是因为该宏在此工作簿中不可用，或者所有的宏都被禁用。</font></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$xlmodule</span> =<span class="variable">$workbook</span>.VBProject.VBComponents.Add([Microsoft.Vbe.Interop.vbext_ComponentType]::vbext_ct_StdModule) <span class="comment"># add a module</span></span><br><span class="line">找不到类型 [Microsoft.Vbe.Interop.vbext_ComponentType]。</span><br><span class="line">所在位置 行:<span class="number">1</span> 字符: <span class="number">49</span></span><br><span class="line">+ ... .VBComponents.Add([Microsoft.Vbe.Interop.vbext_ComponentType]::vbext_ ...</span><br><span class="line">+                       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : InvalidOperation: (Microsoft.Vbe.I...t_ComponentType:TypeName) []，RuntimeException</span><br><span class="line">    + FullyQualifiedErrorId : TypeNotFound</span><br></pre></td></tr></table></figure>

<p>我查了下[Microsoft.Vbe.Interop.vbext_ComponentType]这个类，其定义在<code>Microsoft.Vbe.Interop.dll</code>这个DLL里面，一般可能在在C:\Windows\System32或者C:\Windows\SysWOW64下面，而我是<code>科学安装</code>的excel（你懂的），所以组件可能有点阉割，我看了下我这2个文件夹下是没有这个DLL文件的。</p>
<p>但是比较巧的是我安装了印象笔记，它因为要支持excel，word在笔记里面的编辑，其安装目录下恰好是有这个文件的。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6ftzk06byj30gb077q34.jpg"><br><div>28-6 VBE DLL</div></center>

<p>我会把这个DLL文件一并上传到码云上，如果你也出现这个问题的话到时候下下来，然后在上面出错那一行代码前面运行下面的代码：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在powershell中加载DLL文件，以后专门来讲这一块</span></span><br><span class="line">[void][System.Reflection.Assembly]::Load([io.file]::ReadAllBytes(<span class="string">"full path of Microsoft.Vbe.Interop.dll"</span>))</span><br></pre></td></tr></table></figure>

<h4 id="运行宏并保存"><a href="#运行宏并保存" class="headerlink" title="运行宏并保存"></a>运行宏并保存</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#确保宏是唯一的时候直接调用宏主入口函数</span></span><br><span class="line"><span class="variable">$excel</span>.Run(<span class="string">"CopyCsvFile"</span>)</span><br><span class="line"><span class="comment"># 有多个module，不同的module中可能含有相同名字的函数时，用全名称</span></span><br><span class="line"><span class="variable">$excel</span>.Run(<span class="string">"Module1.CopyCsvFile"</span>)</span><br><span class="line"><span class="comment"># 宏函数带有参数时，用逗号隔开</span></span><br><span class="line"><span class="variable">$excel</span>.Run(<span class="string">"Module1.CopyCsvFile"</span>，<span class="string">"c:\temp\test1.csv"</span>,<span class="string">"c:\temp\test2.csv"</span>)</span><br><span class="line"><span class="comment"># 另存文件， 确保文件后缀和指定类型一致。</span></span><br><span class="line"><span class="variable">$workbook</span>.SaveAs(<span class="string">"C:\temp\result.csv"</span>,[Microsoft.Office.Interop.Excel.XlFileFormat]::xlCSV)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>XlFileFormat请参考 <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.office.interop.excel.xlfileformat?view=excel-pia" target="_blank" rel="noopener">XlFileFormat Enum</a></p>
</blockquote>
<p>这里同样遇到了一个小问题，和上面那个类似，没有需要的DLL文件microsoft.office.interop.excel.dll支持使用[Microsoft.Office.Interop.Excel.XlFileFormat]这个类，也是额外加一行加载DLL的代码。</p>
<p><strong>请注意，如果你的电脑上系统文件夹下已经有这2个DLL文件了，则对应的加载DLL的代码可以注释掉。</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[void][System.Reflection.Assembly]::Load([io.file]::ReadAllBytes(<span class="string">"full path of microsoft.office.interop.excel.dll"</span>))</span><br></pre></td></tr></table></figure>

<h4 id="退出清理"><a href="#退出清理" class="headerlink" title="退出清理"></a>退出清理</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$workbook</span>.close() <span class="comment"># 关闭工作表</span></span><br><span class="line"><span class="variable">$excel</span>.quit() <span class="comment"># 退出excel</span></span><br><span class="line">[void][System.Runtime.Interopservices.Marshal]::FinalReleaseComObject(<span class="variable">$excel</span>)  <span class="comment"># 回收excel com对象</span></span><br><span class="line"><span class="built_in">Remove-Variable</span> excel <span class="comment"># 移除变量</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>回收excel com对象方法使用细节请访问官网 <a href="https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.marshal.releasecomobject(v=vs.110).aspx" target="_blank" rel="noopener">Marshal.ReleaseComObject(Object) Method</a></p>
</blockquote>
<h4 id="完整运行验证"><a href="#完整运行验证" class="headerlink" title="完整运行验证"></a>完整运行验证</h4><h5 id="MacroSource-”Template”"><a href="#MacroSource-”Template”" class="headerlink" title="$MacroSource=”Template”"></a>$MacroSource=”Template”</h5><p>不显示excel, 1s</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6fubbfc4cg30le07in0w.gif"><br><div>28-7 Test1</div></center>

<p>显示excel, 2s</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6fubxmlc3g30le07iaqm.gif"><br>28-8 Test2<div></div></center>

<p>因为我们只用了2个csv而且数据就几行，所以看不出来明显差别，实际中推荐纯后台跑</p>
<h5 id="MacroSource-”ModuleFile”"><a href="#MacroSource-”ModuleFile”" class="headerlink" title="$MacroSource=”ModuleFile”"></a>$MacroSource=”ModuleFile”</h5><center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6fucsogy8g30tv0am0wg.gif"><br><div>28-9 Test3</div></center>

<h5 id="MacroSource-”VBFile”"><a href="#MacroSource-”VBFile”" class="headerlink" title="$MacroSource=”VBFile”"></a>$MacroSource=”VBFile”</h5><center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6fudmx6ctg30tv0amta8.gif"><br><div>28-10 Test4</div></center>

<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>使用powershell调用excel运行macro就说到这了， 细心地你一定发现这个方法原则上来说可以实现对excel的任意操作，各种改格式，画图等等，只要你能录制好正确的宏并在此基础上编辑好VBA code。这里简单讲了下CSV的合并，就当是抛砖引玉了。下一篇打算讲下在没有装excel的电脑上怎么操作excel数据。提前透露下，也是.NET底层的方法。</p>
<p>相关代码，文件<a href="https://gitee.com/chaoyuew/powershell/tree/feature/wechat/SPPS28" target="_blank" rel="noopener">https://gitee.com/chaoyuew/powershell/tree/feature/wechat/SPPS28</a></p>
<blockquote>
<p>参考链接：<br><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms694363(v=vs.85).aspx" target="_blank" rel="noopener">The Component Object Model</a><br><a href="https://docs.microsoft.com/en-us/powershell/scripting/getting-started/cookbooks/creating-.net-and-com-objects--new-object-?view=powershell-6" target="_blank" rel="noopener">Creating .NET and COM Objects (New-Object)</a><br><a href="https://docs.microsoft.com/en-us/office/vba/api/Excel.Application.DisplayAlerts" target="_blank" rel="noopener">Application.DisplayAlerts property (Excel)</a><br><a href="https://aritrasaha.wordpress.com/2010/03/20/add-vba-code-and-references-to-excel-document/" target="_blank" rel="noopener">Add VBA Code and References to Excel Document</a><br><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.office.interop.excel.xlfileformat?view=excel-pia" target="_blank" rel="noopener">XlFileFormat Enum</a><br><a href="https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.marshal.releasecomobject(v=vs.110).aspx" target="_blank" rel="noopener">Marshal.ReleaseComObject(Object) Method</a><br><a href="https://stackoverflow.com/questions/660319/where-can-i-find-all-of-the-com-objects-that-can-be-created-in-powershell" target="_blank" rel="noopener">Where can I find all of the COM objects that can be created in Powershell?</a></p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">超速蜗牛</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://chaoyuew.gitee.io/WPS-28-Advanced-Excel-ComObject.html">https://chaoyuew.gitee.io/WPS-28-Advanced-Excel-ComObject.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chaoyuew.gitee.io">超速蜗牛的博客</a>！</span></div></div></article><div id="pagination"><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/WPS-27-Advanced-PSBASE-And-More.html"><span>Windows PowerShell进阶(27) PSBASE and more</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2019 By 超速蜗牛</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>