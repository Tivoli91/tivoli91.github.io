<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Windows PowerShell进阶(33) 操作XML"><meta name="keywords" content="进阶,IO,XML"><meta name="author" content="超速蜗牛,undefined"><meta name="copyright" content="超速蜗牛"><title>Windows PowerShell进阶(33) 操作XML【超速蜗牛的博客】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"AOHMI93W80","apiKey":"3f74c7e8113768c69c3eedfd6540618f","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#新建XML"><span class="toc-number">1.</span> <span class="toc-text">新建XML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读取XML"><span class="toc-number">2.</span> <span class="toc-text">读取XML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读取特定节点"><span class="toc-number">3.</span> <span class="toc-text">读取特定节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新XML内容"><span class="toc-number">4.</span> <span class="toc-text">更新XML内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加新的节点-数据"><span class="toc-number">5.</span> <span class="toc-text">添加新的节点/数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除XML节点"><span class="toc-number">6.</span> <span class="toc-text">删除XML节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更加强大的功能"><span class="toc-number">7.</span> <span class="toc-text">更加强大的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">超速蜗牛</div><div class="author-info-description">Learn PowerShell.</div><div class="links-buttons"><a class="links-button button-hover" href="https://gitee.com/chaoyuew" target="_blank">Gitee<i class="icon-dot bg-color5"></i></a><a class="links-button button-hover" href="mailto:348001390@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="tencent://message/?uin=348001390&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color8"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">35</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">44</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">2</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">超速蜗牛的博客</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">Windows PowerShell进阶(33) 操作XML</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-09-03 | 更新于 2019-09-03</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/powershell/">powershell</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/进阶/">进阶</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/IO/">IO</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/XML/">XML</a></div></div></div><div class="main-content"><p>本文首发于本人公众号SPPS178,现搬运过来,较原文有所改动.</p>
<p>上篇我们说了powershell批量上传七牛云文件的时候，用到了XML交互，最近一个星期专门看了些文章来把这一知识点梳理下，下面是我看到的比较好的一篇全面讲解XML操作的文章，在翻译的基础上加入了自己的一些看法在里面，希望大家看完有所收获。当然本文需要一点前端的知识比如XML/XPath，还要一点C#的基础。</p>
<hr>
<p>PowerShell具有出色的XML支持。 一开始并不是很明显，但是在这篇文章的讲解后，您很快就能解决日常的XML任务 - 甚至是非常复杂的任务。</p>
<p>因此，让我们看一下如何使用非常简单的PowerShell代码来完成以前在PowerShell之前的时代所做的事情。</p>
<p>让我们从头开始创建XML文档，添加新数据集，更改信息，添加新数据，删除数据，并将更新版本保存到新格式良好的XML文件中。</p>
<a id="more"></a>

<h3 id="新建XML"><a href="#新建XML" class="headerlink" title="新建XML"></a>新建XML</h3><p>从头开始创建全新的XML文档曾经是一项繁琐的工作。 许多脚本编写者都使用纯文本创建XML文件。 虽然没关系，但它很容易出错。 可能是错别字和大小写的问题，您可能会发现自己处于一个不友好的世界，它充满了格式错误且功能失常的XML。</p>
<p>再也不会了，因为有一个伙伴可以帮助您创建XML文档：<code>XMLTextWriter</code>对象。 它隐藏了底层处理原始XML对象模型的复杂性，而是帮助您将各种信息写入XML文件中。</p>
<hr>
<p>编者: 原文是13年写的，所以有些技术可能已经更新了，比如我们访问微软的XMLTextWriter页面，其已经推荐使用<code>System.Xml.XmlWriter</code>代替<code>XMLTextWriter</code>。这里我们主要了解这篇文章的思想即可，老的依然可以用，详细的使用方法大家可以去看微软官方文档，文末有链接。使用的方法其实之前都有说过的，相信理解起来应该不难。</p>
<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mq045d8xj30o208waab.jpg"><br><div>33-1 XmlTextWriter Class</div></center>

<hr>
<p>为了开始这个故事，让我们创建一个相当复杂的XML文档，即将到来的示例可以使用它。 目标是创建一个包含所有典型内容的XML文档：节点，属性，数据部分和注释。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this is where the document will be saved:</span></span><br><span class="line"><span class="variable">$Path</span> = <span class="string">"<span class="variable">$env:temp</span>\inventory.xml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get an XMLTextWriter to create the XML</span></span><br><span class="line"><span class="variable">$XmlWriter</span> = <span class="built_in">New-Object</span> System.XMl.XmlTextWriter(<span class="variable">$Path</span>,<span class="literal">$Null</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># choose a pretty formatting:</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.Formatting = <span class="string">'Indented'</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.Indentation = <span class="number">1</span></span><br><span class="line"><span class="variable">$XmlWriter</span>.IndentChar = <span class="string">"`t"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write the header</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteStartDocument()</span><br><span class="line"></span><br><span class="line"><span class="comment"># set XSL statements</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteProcessingInstruction(<span class="string">"xml-stylesheet"</span>, <span class="string">"type='text/xsl' href='style.xsl'"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># create root element "machines" and add some attributes to it</span></span><br><span class="line"><span class="variable">$XmlWriter</span>.WriteComment(<span class="string">'List of machines'</span>)</span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteStartElement(<span class="string">'Machines'</span>)</span><br><span class="line"><span class="variable">$XmlWriter</span>.WriteAttributeString(<span class="string">'current'</span>, <span class="literal">$true</span>)</span><br><span class="line"><span class="variable">$XmlWriter</span>.WriteAttributeString(<span class="string">'manager'</span>, <span class="string">'Tobias'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a couple of random entries</span></span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$x</span>=<span class="number">1</span>; <span class="variable">$x</span> <span class="nomarkup">-le</span> <span class="number">10</span>; <span class="variable">$x</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$server</span> = <span class="string">'Server&#123;0:0000&#125;'</span> -f <span class="variable">$x</span></span><br><span class="line">    <span class="variable">$ip</span> = <span class="string">'&#123;0&#125;.&#123;1&#125;.&#123;2&#125;.&#123;3&#125;'</span> -f  (<span class="number">0</span>..<span class="number">256</span> | <span class="built_in">Get-Random</span> -Count <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="variable">$guid</span> = [System.GUID]::NewGuid().ToString()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># each data set is called "machine", add a random attribute to it:</span></span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteComment(<span class="string">"<span class="variable">$x</span>. machine details"</span>)</span><br><span class="line">    <span class="variable">$xmlWriter</span>.WriteStartElement(<span class="string">'Machine'</span>)</span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteAttributeString(<span class="string">'test'</span>, (<span class="built_in">Get-Random</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add three pieces of information:</span></span><br><span class="line">    <span class="variable">$xmlWriter</span>.WriteElementString(<span class="string">'Name'</span>,<span class="variable">$server</span>)</span><br><span class="line">    <span class="variable">$xmlWriter</span>.WriteElementString(<span class="string">'IP'</span>,<span class="variable">$ip</span>)</span><br><span class="line">    <span class="variable">$xmlWriter</span>.WriteElementString(<span class="string">'GUID'</span>,<span class="variable">$guid</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add a node with attributes and content:</span></span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteStartElement(<span class="string">'Information'</span>)</span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteAttributeString(<span class="string">'info1'</span>, <span class="string">'some info'</span>)</span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteAttributeString(<span class="string">'info2'</span>, <span class="string">'more info'</span>)</span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteRaw(<span class="string">'RawContent'</span>)</span><br><span class="line">    <span class="variable">$xmlWriter</span>.WriteEndElement()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add a node with CDATA section:</span></span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteStartElement(<span class="string">'CodeSegment'</span>)</span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteAttributeString(<span class="string">'info3'</span>, <span class="string">'another attribute'</span>)</span><br><span class="line">    <span class="variable">$XmlWriter</span>.WriteCData(<span class="string">'this is untouched code and can contain special characters /\@&lt;&gt;'</span>)</span><br><span class="line">    <span class="variable">$xmlWriter</span>.WriteEndElement()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># close the "machine" node:</span></span><br><span class="line">    <span class="variable">$xmlWriter</span>.WriteEndElement()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># close the "machines" node:</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteEndElement()</span><br><span class="line"></span><br><span class="line"><span class="comment"># finalize the document:</span></span><br><span class="line"><span class="variable">$xmlWriter</span>.WriteEndDocument()</span><br><span class="line"><span class="variable">$xmlWriter</span>.Flush()</span><br><span class="line"><span class="variable">$xmlWriter</span>.Close()</span><br><span class="line"></span><br><span class="line">ii <span class="variable">$path</span></span><br></pre></td></tr></table></figure>

<p>此脚本生成包含大量随机信息的虚假服务器清单。 结果在记事本中打开，看起来与此类似：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type='text/xsl' href='style.xsl'?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--List of machines--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Machines</span> <span class="attr">current</span>=<span class="string">"True"</span> <span class="attr">manager</span>=<span class="string">"Tobias"</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--1. machine details--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Machine</span> <span class="attr">test</span>=<span class="string">"578163632"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Server0001<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">IP</span>&gt;</span>31.248.95.170<span class="tag">&lt;/<span class="name">IP</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">GUID</span>&gt;</span>51cb0dfb-75ed-4967-8392-47d87596c73c<span class="tag">&lt;/<span class="name">GUID</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Information</span> <span class="attr">info1</span>=<span class="string">"some info"</span> <span class="attr">info2</span>=<span class="string">"more info"</span>&gt;</span>RawContent<span class="tag">&lt;/<span class="name">Information</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">CodeSegment</span> <span class="attr">info3</span>=<span class="string">"another attribute"</span>&gt;</span>&lt;![CDATA[this is untouched code and can contain special characters /\@&lt;&gt;]]&gt;<span class="tag">&lt;/<span class="name">CodeSegment</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Machine</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!--2. machine details--&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Machine</span> <span class="attr">test</span>=<span class="string">"124214010"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Name</span>&gt;</span>Server0002<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">IP</span>&gt;</span>33.60.233.89<span class="tag">&lt;/<span class="name">IP</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">GUID</span>&gt;</span>9618b8bc-c200-46ce-b423-ee030555242d<span class="tag">&lt;/<span class="name">GUID</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Information</span> <span class="attr">info1</span>=<span class="string">"some info"</span> <span class="attr">info2</span>=<span class="string">"more info"</span>&gt;</span>RawContent<span class="tag">&lt;/<span class="name">Information</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">CodeSegment</span> <span class="attr">info3</span>=<span class="string">"another attribute"</span>&gt;</span>&lt;![CDATA[this is untouched code and can contain special characters /\@&lt;&gt;]]&gt;<span class="tag">&lt;/<span class="name">CodeSegment</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Machine</span>&gt;</span></span><br><span class="line">(...)</span><br><span class="line"><span class="tag">&lt;/<span class="name">Machines</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个XML文档的目的有两个：它是一个如何从头开始创建XML文件的示例，它可以作为以下练习的示例数据。</p>
<p>假设这是一个包含相关信息的XML文件。 您可以将要学习的策略应用于任何格式良好的XML文件。</p>
<p><strong>注意</strong>：XMLTextWriter为您提供了很多魔力，但您有责任创建有意义的内容。 容易让人头疼的问题之一是格式错误的节点名称。 节点名称不得包含空格。</p>
<p>因此，虽然“CodeSegment”没问题，但“Code Segment”也不行。 XML会尝试将您的节点命名为“Code”，然后添加一个名为“Segment”的属性，最后会阻止您从未为该属性(“CodeSegment”)赋值。</p>
<h3 id="读取XML"><a href="#读取XML" class="headerlink" title="读取XML"></a>读取XML</h3><p>一个常见任务是从XML文件中提取信息。 假设您需要一个机器列表及其IP地址。 如果您已生成上面的示例XML文件，那么这就是创建报告所需的全部内容：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this is where the XML sample file was saved:</span></span><br><span class="line"><span class="variable">$Path</span> = <span class="string">"<span class="variable">$env:temp</span>\inventory.xml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># load it into an XML object:</span></span><br><span class="line"><span class="variable">$xml</span> = <span class="built_in">New-Object</span> -TypeName XML</span><br><span class="line"><span class="variable">$xml</span>.Load(<span class="variable">$Path</span>)</span><br><span class="line"><span class="comment"># note: if your XML is malformed, you will get an exception here</span></span><br><span class="line"><span class="comment"># always make sure your node names do not contain spaces</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># simply traverse the nodes and select the information you want:</span></span><br><span class="line"><span class="variable">$Xml</span>.Machines.Machine | <span class="built_in">Select-Object</span> -Property Name, IP</span><br></pre></td></tr></table></figure>

<p>结果看起来与此类似：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Name          IP</span><br><span class="line">----          --</span><br><span class="line">Server0001    <span class="number">31.248</span>.<span class="number">95.170</span></span><br><span class="line">Server0002    <span class="number">33.60</span>.<span class="number">233.89</span></span><br><span class="line">Server0003    <span class="number">226.6</span>.<span class="number">1.30</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>注意：有些人可能想知道为什么我上面最初示例使用XML对象。 通常你会发现这样的代码：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this is where the xml sample file was saved:</span></span><br><span class="line"><span class="variable">$Path</span> = <span class="string">"<span class="variable">$env:temp</span>\inventory.xml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># load it into an XML object:</span></span><br><span class="line">[XML]<span class="variable">$xml</span> = <span class="built_in">Get-Content</span> <span class="variable">$Path</span></span><br></pre></td></tr></table></figure>

<p>最简单的原因就是二者之间的性能。 通过Get-Content将XML文件作为纯文本文件读取，然后在第二步中将其转换为XML是一种非常昂贵的方法。 即使我们的XML文件不是那么大，<code>后一种解决方案所花费的时间几乎是第一种解决方案的7倍</code>，而随着XML文件内容的增加，相应时间也会增加。</p>
<p>因此，只要您想加载XML文件，请确保获取XML对象并使用其Load()方法。 通过接受URL的方式，这种方法是通用的，因此您也可以使用URL到您喜欢的RSS源 - 前提是您可以直接访问Internet并且无需配置代理设置。</p>
<hr>
<p>编者:关于上面原文提到的这个性能这一点，我这里稍微提一下，其实我自己一直在用<code>$xml = [XML](Get-Content $Path)</code>这种方法来加载和读取XML。关于这个时间性能的开销，我自己就用上面创建好的XML文件测试了一下。可以看到用<code>New-Object</code>的方式是比<code>[xml]</code>的方式快了2.4倍，但是这个单位是毫秒，如果我们平常的使用不在乎这1,2毫秒的差别，就怎么使用方便怎么来吧，也不是说就必须只能用<code>New-Object</code>的方式。大家自己要根据实际开发环境取舍。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Measure-Command</span> &#123;</span><br><span class="line">    <span class="variable">$x1</span>=[xml](cat C:\Users\ChaoYue\AppData\Local\Temp\inventory.xml)</span><br><span class="line">&#125;|select TotalMilliseconds</span><br><span class="line"></span><br><span class="line"><span class="built_in">Measure-Command</span> &#123;</span><br><span class="line">    [xml]<span class="variable">$x2</span>=cat C:\Users\ChaoYue\AppData\Local\Temp\inventory.xml</span><br><span class="line">&#125;|select TotalMilliseconds</span><br><span class="line"></span><br><span class="line"><span class="built_in">Measure-Command</span> &#123;</span><br><span class="line">    <span class="variable">$x3</span> = <span class="built_in">New-Object</span> -TypeName XML</span><br><span class="line">    <span class="variable">$x3</span>.Load(<span class="string">"C:\Users\ChaoYue\AppData\Local\Temp\inventory.xml"</span>)</span><br><span class="line">&#125;|select TotalMilliseconds</span><br><span class="line"></span><br><span class="line">TotalMilliseconds</span><br><span class="line">-----------------</span><br><span class="line">           <span class="number">1.0538</span></span><br><span class="line">           <span class="number">1.0053</span></span><br><span class="line">           <span class="number">0.4353</span></span><br><span class="line"></span><br><span class="line">PS C:\Users\SPPS&gt; <span class="number">1.0538</span> / <span class="number">0.4353</span></span><br><span class="line"><span class="number">2.42085917757868</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="读取特定节点"><a href="#读取特定节点" class="headerlink" title="读取特定节点"></a>读取特定节点</h3><p>假设您不想要所有服务器的列表，而只想查找列表中特定服务器的IP地址和信息属性<code>info1</code>。 您可以使用相同的方法：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Xml</span>.Machines.Machine |</span><br><span class="line"><span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Name <span class="nomarkup">-eq</span> <span class="string">'Server0009'</span> &#125; |</span><br><span class="line"><span class="built_in">Select-Object</span> -Property IP, &#123;<span class="variable">$_</span>.Information.info1&#125;</span><br></pre></td></tr></table></figure>

<p>这将获得“server0009”的IP地址加上info1属性。 您可以使用XPath（一种前端查询语言）来直接查询和获取特定节点，而不用像上面那样去筛选找到特定的节点。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$item</span> = <span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machine[Name="Server0009"]'</span></span><br><span class="line"><span class="variable">$item</span>.Node | <span class="built_in">Select-Object</span> -Property IP,  @&#123;Name=<span class="string">'AdditionalInfo'</span>; Expression=&#123;<span class="variable">$_</span>.Information.Info1&#125;&#125;</span><br><span class="line"></span><br><span class="line">IP              AdditionalInfo</span><br><span class="line">--              --------------</span><br><span class="line"><span class="number">97.196</span>.<span class="number">140.12</span>   some info</span><br></pre></td></tr></table></figure>

<p><strong>重要说明</strong>：XPath区分大小写，因此如果节点名称为“Machine”，则无法查询“machine”。</p>
<p>XPath是一种非常强大的XML查询语言。 您可以在Internet上找到有关其语法的信息( 请查看以下链接，例如：<a href="http://www.w3schools.com/xpath/和http://go.microsoft.com/fwlink/?LinkId=143609" target="_blank" rel="noopener">http://www.w3schools.com/xpath/和http://go.microsoft.com/fwlink/?LinkId=143609</a> )。 当您阅读这些文档时，您会发现XPath也可以使用所谓的“用户定义函数”，如last()或lowercase()，这里就不详细介绍了。</p>
<hr>
<p>编者：关于上面原文所提到的这个XPath区分大小写问题，我们知道powershell是不区分大小写的，那么我们要怎么在使用powershell获取XML节点时可以不区分大小写呢？ 为了解决这个问题，目前结合我自己会的和Google之后有2个方法，下面结合这个我创建的奇怪的XML来测试说下，这个XML的所有子节点其实都是类似的，只不过是大小写之分。</p>
<ul>
<li>节点名称 ：tag/TAG</li>
<li>属性名称 ：class/CLASS</li>
<li>属性值   ：abc/ABC</li>
<li>节点值   ：全小写的 tag|class|abc –&gt; 全大写的 TAG|CLASS|ABC</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--all lower(tag, attribute name &amp; value) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag</span> <span class="attr">class</span>=<span class="string">'abc'</span> <span class="attr">id</span>=<span class="string">'1'</span>&gt;</span>tag|class|abc<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--one upper, 2 lower --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TAG</span> <span class="attr">class</span>=<span class="string">'abc'</span> <span class="attr">id</span>=<span class="string">'2'</span>&gt;</span>TAG|class|abc<span class="tag">&lt;/<span class="name">TAG</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag</span> <span class="attr">CLASS</span>=<span class="string">'abc'</span> <span class="attr">id</span>=<span class="string">'3'</span>&gt;</span>tag|CLASS|abc<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag</span> <span class="attr">class</span>=<span class="string">'ABC'</span> <span class="attr">id</span>=<span class="string">'4'</span>&gt;</span>tag|class|ABC<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--one lower, 2 upper --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TAG</span> <span class="attr">CLASS</span>=<span class="string">'abc'</span> <span class="attr">id</span>=<span class="string">'5'</span>&gt;</span>TAG|CLASS|abc<span class="tag">&lt;/<span class="name">TAG</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tag</span> <span class="attr">CLASS</span>=<span class="string">'ABC'</span> <span class="attr">id</span>=<span class="string">'6'</span>&gt;</span>tag|CLASS|ABC<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TAG</span> <span class="attr">class</span>=<span class="string">'ABC'</span> <span class="attr">id</span>=<span class="string">'7'</span>&gt;</span>TAG|class|ABC<span class="tag">&lt;/<span class="name">TAG</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--all upper --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TAG</span> <span class="attr">CLASS</span>=<span class="string">'ABC'</span> <span class="attr">id</span>=<span class="string">'8'</span>&gt;</span>TAG|CLASS|ABC<span class="tag">&lt;/<span class="name">TAG</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--text case test--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text1</span>&gt;</span>string<span class="tag">&lt;/<span class="name">text1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text2</span>&gt;</span>STRING<span class="tag">&lt;/<span class="name">text2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">subtag</span>&gt;</span>upexpected string<span class="tag">&lt;/<span class="name">subtag</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">text3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>针对单节点，不使用XPath，而是用属性的方式去获取。我们使用<code>$x.Root.tag</code>或者<code>$x.DocumentElement.tag</code>可以获取到所有名称是tag/TAG的子节点，无论大小写， 如果用单纯的XPATH就不行，只能获取名称是小写tag的子节点。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\SPPS&gt; [xml]<span class="variable">$x</span>=cat C:\temp\xpath-test.xml</span><br><span class="line"></span><br><span class="line">PS C:\Users\SPPS&gt; <span class="variable">$x</span>.Root.tag <span class="comment"># $x.DocumentElement.tag效果相同，可以获取到所有名称是tag/TAG的子节点，无论大小写。</span></span><br><span class="line"></span><br><span class="line">class id <span class="comment">#text        </span></span><br><span class="line">----- -- -----        </span><br><span class="line">abc   <span class="number">1</span>  tag|class|abc</span><br><span class="line">abc   <span class="number">2</span>  TAG|class|abc</span><br><span class="line">abc   <span class="number">3</span>  tag|CLASS|abc</span><br><span class="line">ABC   <span class="number">4</span>  tag|class|ABC</span><br><span class="line">abc   <span class="number">5</span>  TAG|CLASS|abc</span><br><span class="line">ABC   <span class="number">6</span>  tag|CLASS|ABC</span><br><span class="line">ABC   <span class="number">7</span>  TAG|class|ABC</span><br><span class="line">ABC   <span class="number">8</span>  TAG|CLASS|ABC</span><br><span class="line"></span><br><span class="line">PS C:\Users\SPPS&gt; <span class="variable">$x</span>.SelectNodes(<span class="string">"//tag"</span>) <span class="comment"># 只能获取名称是小写tag的子节点。</span></span><br><span class="line"></span><br><span class="line">class id <span class="comment">#text        </span></span><br><span class="line">----- -- -----        </span><br><span class="line">abc   <span class="number">1</span>  tag|class|abc</span><br><span class="line">abc   <span class="number">3</span>  tag|CLASS|abc</span><br><span class="line">ABC   <span class="number">4</span>  tag|class|ABC</span><br><span class="line">ABC   <span class="number">6</span>  tag|CLASS|ABC</span><br></pre></td></tr></table></figure>

<ul>
<li>使用XPATH的函数<code>translate()</code>,下面效果和上面一致，可以获取到所有名称是tag的子节点，无论大小写。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\SPPS&gt; <span class="variable">$x</span>.SelectNodes(<span class="string">"//*[translate(local-name(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')='tag']"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class id <span class="comment">#text        </span></span><br><span class="line">----- -- -----        </span><br><span class="line">abc   <span class="number">1</span>  tag|class|abc</span><br><span class="line">abc   <span class="number">2</span>  TAG|class|abc</span><br><span class="line">abc   <span class="number">3</span>  tag|CLASS|abc</span><br><span class="line">ABC   <span class="number">4</span>  tag|class|ABC</span><br><span class="line">abc   <span class="number">5</span>  TAG|CLASS|abc</span><br><span class="line">ABC   <span class="number">6</span>  tag|CLASS|ABC</span><br><span class="line">ABC   <span class="number">7</span>  TAG|class|ABC</span><br><span class="line">ABC   <span class="number">8</span>  TAG|CLASS|ABC</span><br></pre></td></tr></table></figure>

<p>下面是获取<code>属性名称</code>是class/CLASS的所有节点，不区分大小写。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\SPPS&gt; <span class="variable">$x</span>.SelectNodes(<span class="string">"//*[attribute::*[translate(local-name(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')='class']]"</span>)</span><br><span class="line"></span><br><span class="line">class id <span class="comment">#text        </span></span><br><span class="line">----- -- -----        </span><br><span class="line">abc   <span class="number">1</span>  tag|class|abc</span><br><span class="line">abc   <span class="number">2</span>  TAG|class|abc</span><br><span class="line">abc   <span class="number">3</span>  tag|CLASS|abc</span><br><span class="line">ABC   <span class="number">4</span>  tag|class|ABC</span><br><span class="line">abc   <span class="number">5</span>  TAG|CLASS|abc</span><br><span class="line">ABC   <span class="number">6</span>  tag|CLASS|ABC</span><br><span class="line">ABC   <span class="number">7</span>  TAG|class|ABC</span><br><span class="line">ABC   <span class="number">8</span>  TAG|CLASS|ABC</span><br></pre></td></tr></table></figure>

<p>XPATH的深入使用不在本公众号的支持范围内，后面会有相关参考链接，还请大家自行学习了解，下面是我根据函数<code>translate()</code>总结的一些可能用得到的XPATH使用技巧，可以做到不区分大小写查找。大家自己机子上跑下看下效果，加深理解和体会。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$x</span>=(<span class="built_in">New-Object</span> -TypeName XML)</span><br><span class="line"><span class="variable">$x</span>.Load(<span class="string">"C:\temp\DBConfig.xml"</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.DocumentElement.tag.<span class="string">'#text'</span></span><br><span class="line">    <span class="keyword">return</span> all tags value</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//*[translate(local-name(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')='tag']"</span>)</span><br><span class="line">    <span class="keyword">return</span> all tags value</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//*[translate(@class, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz') ='abc']"</span>)</span><br><span class="line">    <span class="keyword">return</span> any class value that equals <span class="string">'abc'</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//*[contains(translate(text(),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz'),'string')]"</span>)</span><br><span class="line">    node 值部分匹配</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//*[(translate(text(),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz'))='string']"</span>)</span><br><span class="line">    node 值完全匹配</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//@*[name()='CLASS']"</span>) <span class="comment"># get attribute name</span></span><br><span class="line">    <span class="keyword">return</span> attribute value</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//*[attribute::*[local-name()='class']]"</span>) <span class="comment"># get attribute name, case sensitive</span></span><br><span class="line">    <span class="keyword">return</span> attribute name that equals class with case sensitive</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//*[attribute::*[translate(local-name(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')='class']]"</span>)</span><br><span class="line">    <span class="keyword">return</span> attribute name that equals class with case insensitive</span><br><span class="line"></span><br><span class="line"><span class="variable">$x</span>.SelectNodes(<span class="string">"//tag[attribute::*[local-name()='class'] and @class='abc' ]"</span>)</span><br><span class="line">    get </span><br><span class="line">    <span class="number">1</span>. tag name equals lower <span class="string">'tag'</span> and </span><br><span class="line">    <span class="number">2</span>. attribute name equals lower <span class="string">'class'</span> and </span><br><span class="line">    <span class="number">3</span>. attribute value equals lower <span class="string">'abc'</span></span><br></pre></td></tr></table></figure>

<p>另：我在准备这篇文章的这一周内，才知道原来XML也有namespace这一概念，还是平时这一块用的少，知识盲区。文末有参考链接，感兴趣的可以了解下，作为课外拓展。</p>
<hr>
<h3 id="更新XML内容"><a href="#更新XML内容" class="headerlink" title="更新XML内容"></a>更新XML内容</h3><p>通常，您需要更新XML文档中的信息。 而不是自己解析XML，只需坚持你刚刚学到的技术。因此，如果您想更新Server0006并为其分配新名称和不同的IP地址，那么您可以这样做：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$item</span> = <span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machine[Name="Server0006"]'</span></span><br><span class="line"><span class="variable">$item</span>.node.Name = <span class="string">"NewServer0006"</span></span><br><span class="line"><span class="variable">$item</span>.node.IP = <span class="string">"10.10.10.12"</span></span><br><span class="line"><span class="variable">$item</span>.node.Information.Info1 = <span class="string">'new attribute info'</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$NewPath</span> = <span class="string">"<span class="variable">$env:temp</span>\inventory2.xml"</span></span><br><span class="line"><span class="variable">$xml</span>.Save(<span class="variable">$NewPath</span>)</span><br><span class="line">ii <span class="variable">$NewPath</span></span><br></pre></td></tr></table></figure>

<p>如您所见，更新信息很简单，您所做的所有更改都会自动应用于基础XML对象。 您需要做的就是将更改的XML对象保存到文件中以使更改成为永久更改。 结果显示在记事本编辑器中，看起来类似于：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--6. machine details--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Machine</span> <span class="attr">test</span>=<span class="string">"559669990"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Name</span>&gt;</span>NewServer0006<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">IP</span>&gt;</span>10.10.10.12<span class="tag">&lt;/<span class="name">IP</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">GUID</span>&gt;</span>cca8df99-78e1-48e0-8c4d-193c6d4acbd2<span class="tag">&lt;/<span class="name">GUID</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Information</span> <span class="attr">info1</span>=<span class="string">"new attribute info"</span> <span class="attr">info2</span>=<span class="string">"more info"</span>&gt;</span>RawContent<span class="tag">&lt;/<span class="name">Information</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">CodeSegment</span> <span class="attr">info3</span>=<span class="string">"another attribute"</span>&gt;</span>&lt;![CDATA[this is untouched code and can contain special characters /\@&lt;&gt;]]&gt;<span class="tag">&lt;/<span class="name">CodeSegment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Machine</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>您刚刚对现有XML文档进行了更改，没有棘手的解析，也没有破坏XML结构的风险。以同样的方式，您可以进行批量调整。 让我们假设所有服务器都要获得全新的名称。 而不是<code>ServerXXXX</code>，现在需要将机器命名为<code>Prod_ServerXXXX</code>。 这是解决方案：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Foreach</span> (<span class="variable">$item</span> <span class="keyword">in</span> (<span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machine'</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$item</span>.node.Name = <span class="string">'Prod_'</span> + <span class="variable">$item</span>.node.Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$NewPath</span> = <span class="string">"<span class="variable">$env:temp</span>\inventory2.xml"</span></span><br><span class="line"><span class="variable">$xml</span>.Save(<span class="variable">$NewPath</span>)</span><br><span class="line">ii <span class="variable">$NewPath</span></span><br></pre></td></tr></table></figure>

<p>请注意XML文档中的所有服务器名称是如何更新的。 Select-XML这次不会返回一个对象，而是多个，每个服务器一个。 这是因为XPath这次选择所有“机器”节点而没有特殊过滤。 这就是为什么所有这些节点都需要在foreach循环中处理的原因。</p>
<p>在循环内部，为节点<code>name</code>分配一个新值，并且一旦更新了所有<code>Machine</code>节点，就会在记事本中保存并打开XML文档。</p>
<p>您可能会争辩说，在此示例中，在服务器名称前添加“Prod_”实际上是一个微不足道的变化，这是事实。 可能有更复杂的要求。 <code>但是，这里的重点是展示如何从根本上改变XML数据，而不是如何进行复杂的字符串操作。</code></p>
<p>但是，如果您问自己如何，例如，将“ServerXXXX”替换为“PCXX”（包括将4位数字转换为2位数字，这绝对不是一个微不足道的变化），这是一个解决方案：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="variable">$item</span> <span class="keyword">in</span> (<span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machine'</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$item</span>.node.Name <span class="nomarkup">-match</span> <span class="string">'Server(\d&#123;4&#125;)'</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="variable">$item</span>.node.Name = <span class="string">'PC&#123;0:00&#125;'</span> -f [Int]<span class="variable">$matches</span>[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$NewPath</span> = <span class="string">"<span class="variable">$env:temp</span>\inventory2.xml"</span></span><br><span class="line"><span class="variable">$xml</span>.Save(<span class="variable">$NewPath</span>)</span><br><span class="line">ii <span class="variable">$NewPath</span></span><br></pre></td></tr></table></figure>

<p>这次，正则表达式提取原始服务器名称的数字部分，然后-f运算符重新格式化该数字并将其添加到新服务器前缀。</p>
<p>正则表达式和数字格式都不是本文的重点。 重要的是要看到您可以自由地使用您喜欢的任何技术来构建新的服务器名称。 但是，更改XML内容始终遵循相同的规则。</p>
<hr>
<p>编者：关于更新节点数据，我曾经遇到了一个很奇怪的问题，就是在给节点赋新值的时候会报错：Cannot set “xxx” because only strings can be used as values to set XmlNode properties.后来查了下发现要用下面的方法才行,一般情况下这个方法是不会报错的，但是如果你真的遇到这个错误可以用下面的方法试着解决。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$x1</span> = <span class="built_in">Select-Xml</span> <span class="variable">$x</span> -XPath <span class="string">"//text1"</span></span><br><span class="line"><span class="comment"># $x1.Node.'#text' = "aaa" # not working，will have error we mentioned above</span></span><br><span class="line"><span class="variable">$x1</span>.Node.<span class="string">'#text'</span> = <span class="string">"aaa"</span>.psobject.baseobject <span class="comment">#use this way to set node text value</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="添加新的节点-数据"><a href="#添加新的节点-数据" class="headerlink" title="添加新的节点/数据"></a>添加新的节点/数据</h3><p>有时，更新数据是不够的。 您可能希望将新计算机添加到列表中。 同样，这很简单。 您只需选择一个现有节点，克隆它，然后更新其内容并将其附加到您喜欢的父节点。 这样，您不必自己创建复杂的节点结构，并且可以确定新节点的结构与任何现有节点一样。</p>
<p>这会将新机器添加到机器列表中：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clone an existing node structure</span></span><br><span class="line"><span class="variable">$item</span> = <span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machine[1]'</span></span><br><span class="line"><span class="variable">$newnode</span> = <span class="variable">$item</span>.Node.CloneNode(<span class="literal">$true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># update the information as needed</span></span><br><span class="line"><span class="comment"># all other information is defaulted to the values from the original node</span></span><br><span class="line"><span class="variable">$newnode</span>.Name = <span class="string">'NewServer'</span></span><br><span class="line"><span class="variable">$newnode</span>.IP = <span class="string">'1.2.3.4'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get the node you want the new node to be appended to:</span></span><br><span class="line"><span class="variable">$machines</span> = <span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machines'</span></span><br><span class="line"><span class="variable">$machines</span>.Node.AppendChild(<span class="variable">$newnode</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">$NewPath</span> = <span class="string">"<span class="variable">$env:temp</span>\inventory2.xml"</span></span><br><span class="line"><span class="variable">$xml</span>.Save(<span class="variable">$NewPath</span>)</span><br><span class="line">ii <span class="variable">$NewPath</span></span><br></pre></td></tr></table></figure>

<p>由于要添加的节点是从现有节点克隆的，因此将从现有节点复制此新节点中的所有信息。 您未更新的信息将保留旧值。如果您想将新节点添加到列表顶部怎么办？ 只需使用InsertBefore()而不是AppendChild()：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add it to the top of the list:</span></span><br><span class="line"><span class="variable">$machines</span>.Node.InsertBefore(<span class="variable">$newnode</span>, <span class="variable">$item</span>.node)</span><br></pre></td></tr></table></figure>

<p>同样，您基本上可以在任何地方插入新节点。 这将在Server0007之后插入：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add it after "Server0007":</span></span><br><span class="line"><span class="variable">$parent</span> = <span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machine[Name="Server0007"]'</span></span><br><span class="line"><span class="variable">$machines</span>.Node.InsertAfter(<span class="variable">$newnode</span>, <span class="variable">$parent</span>.node)</span><br></pre></td></tr></table></figure>

<h3 id="删除XML节点"><a href="#删除XML节点" class="headerlink" title="删除XML节点"></a>删除XML节点</h3><p>完全从XML文件中删除数据同样简单。 如果您想从列表中删除Server0007，请按以下步骤操作：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># remove "Server0007":</span></span><br><span class="line"><span class="variable">$item</span> = <span class="built_in">Select-XML</span> -Xml <span class="variable">$xml</span> -XPath <span class="string">'//Machine[Name="Server0007"]'</span></span><br><span class="line"><span class="literal">$null</span> = <span class="variable">$item</span>.Node.ParentNode.RemoveChild(<span class="variable">$item</span>.node)</span><br></pre></td></tr></table></figure>

<h3 id="更加强大的功能"><a href="#更加强大的功能" class="headerlink" title="更加强大的功能"></a>更加强大的功能</h3><p>通过提供的示例，您现在可以在几行代码中管理最常用的XML操作。非常值得花一些时间来提高您的XML和XPath熟练程度 - 您可以用它们做出惊人的事情。</p>
<p>对于那些长期坚持关注我的人，我有一个小礼物给你：我经常使用的一个很棒的小工具，对你来说也很有帮助，我相信。它使用您刚才听到的完全相同的策略。这是故事：</p>
<p>ConvertTo-XML可以将任何对象转换为XML，并且由于XML是一种分层数据格式，保留了给定深度的结构，因此它是检查嵌套对象属性的绝佳方法。因此，您可以“展开”对象结构并查看其所有属性，甚至是深度嵌套的属性。</p>
<p>如果没有XML和XPath，您所能做的就是查看纯XML并自己搜索信息。例如，如果您想要找出<code>$host</code>对象存储PowerShell的颜色信息的确切位置，您可以这样做（毕竟这可能不是一个好主意，因为您充斥着原始XML信息）：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$host</span> | <span class="built_in">ConvertTo-XML</span> -Depth <span class="number">5</span> | <span class="built_in">Select-Object</span> -ExpandProperty outerXML</span><br></pre></td></tr></table></figure>

<p>通过刚刚介绍的知识，您现在可以获取原始XML并提取和过滤对象属性。</p>
<p>所以这里是承诺的函数Get-ObjectProperty，它有点像自带的Get-Member。 它可以告诉您对象中的哪个属性包含您所追求的值。 看一看：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS&gt; <span class="variable">$host</span> | Get-ObjectProperty -Depth <span class="number">2</span> -Name *color*</span><br><span class="line"></span><br><span class="line">Name                    Value                   Path                    Type</span><br><span class="line">----                    -----                   ----                    ----</span><br><span class="line">TokenColors                                     <span class="variable">$obj1</span>.PrivateData.To... Microsoft.PowerShel...</span><br><span class="line">ConsoleTokenColors                              <span class="variable">$obj1</span>.PrivateData.Co... Microsoft.PowerShel...</span><br><span class="line">XmlTokenColors                                  <span class="variable">$obj1</span>.PrivateData.Xm... Microsoft.PowerShel...</span><br><span class="line">(...)</span><br></pre></td></tr></table></figure>

<p>这将返回<code>$host</code>中名称中包含“Color”的所有嵌套属性。控制台输出很可能被截断，因此最好在网格视图窗口中显示信息：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$host</span> | Get-ObjectProperty -Depth <span class="number">2</span> -Name *color* | <span class="built_in">Out-GridView</span></span><br></pre></td></tr></table></figure>

<center><img style="border-radius: 0.3125em;box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" src="http://ww1.sinaimg.cn/large/007tGxtGgy1g6mq17jffmj313j0cagnb.jpg"><br><div>33-2 视窗视图</div></center>

<p>请注意<code>Path</code>列：此属性指定您将如何访问给定的嵌套属性。 在该示例中，<code>Get-ObjectProperty</code>在对象层次结构内深度走两层。 更深的深度将展示更多的信息，但也会使用更无关的噪声信息污染结果。</p>
<p>虽然您可以管道多个对象，但最好只管理一个对象，因为产生了大量的数据。 此行将列出流程对象中的所有嵌套属性，深度为五级，具有数值：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS&gt; <span class="built_in">Get-Process</span> -id <span class="variable">$pid</span> | Get-ObjectProperty -Depth <span class="number">5</span> -IsNumeric</span><br><span class="line"></span><br><span class="line">Name                    Value                   Path                    Type</span><br><span class="line">----                    -----                   ----                    ----</span><br><span class="line">Handles                 <span class="number">684</span>                     <span class="variable">$obj1</span>.Handles           System.Int32</span><br><span class="line">VM                      <span class="number">1010708480</span>              <span class="variable">$obj1</span>.VM                System.Int32</span><br><span class="line">WS                      <span class="number">291446784</span>               <span class="variable">$obj1</span>.WS                System.Int32</span><br><span class="line">PM                      <span class="number">251645952</span>               <span class="variable">$obj1</span>.PM                System.Int32</span><br><span class="line">(...)</span><br></pre></td></tr></table></figure>

<p>此行将返回类型为<code>String</code>的后台处理程序服务对象的所有嵌套属性：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS&gt; <span class="built_in">Get-Service</span> -Name spooler | Get-ObjectProperty -Type System.String</span><br><span class="line"></span><br><span class="line">Name                    Value                   Path                    Type</span><br><span class="line">----                    -----                   ----                    ----</span><br><span class="line">Name                    spooler                 <span class="variable">$obj1</span>.Name              System.String</span><br><span class="line">Name                    RPCSS                   <span class="variable">$obj1</span>.RequiredServic... System.String</span><br><span class="line">Name                    DcomLaunch              <span class="variable">$obj1</span>.RequiredServic... System.String</span><br><span class="line">(...)</span><br></pre></td></tr></table></figure>

<p>这是Get-ObjectProperty的源代码。 考虑到它为你所做的工作，它比仅仅几行更复杂，但仍然非常短。</p>
<p>它使用刚刚解释过的完全相同的技术，所以一旦你对上面的简单例子感到满意，你也可以尝试消化这个 - 或者只是将它用作工具而不用担心它的XML魔法：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span> Get-ObjectProperty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">param</span></span><br><span class="line">  (</span><br><span class="line">    <span class="variable">$Name</span> = <span class="string">'*'</span>,</span><br><span class="line">    <span class="variable">$Value</span> = <span class="string">'*'</span>,</span><br><span class="line">    <span class="variable">$Type</span> = <span class="string">'*'</span>,</span><br><span class="line">    [Switch]<span class="variable">$IsNumeric</span>,</span><br><span class="line"></span><br><span class="line">    [Parameter(Mandatory=<span class="literal">$true</span>,ValueFromPipeline=<span class="literal">$true</span>)]</span><br><span class="line">    [Object[]]<span class="variable">$InputObject</span>,</span><br><span class="line"></span><br><span class="line">    <span class="variable">$Depth</span> = <span class="number">4</span>,</span><br><span class="line">    <span class="variable">$Prefix</span> = <span class="string">'$obj'</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">Begin</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$x</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">Function</span> Get-Property</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">param</span></span><br><span class="line">      (</span><br><span class="line">        <span class="variable">$Node</span>,</span><br><span class="line">        [String[]]<span class="variable">$Prefix</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="variable">$Value</span> = @&#123;Name=<span class="string">'Value'</span>; Expression=&#123;<span class="variable">$_</span>.<span class="string">'#text'</span> &#125;&#125;</span><br><span class="line">      <span class="built_in">Select-Xml</span> -Xml <span class="variable">$Node</span> -XPath <span class="string">'Property'</span> | <span class="built_in">ForEach-Object</span> &#123;<span class="variable">$i</span>=<span class="number">0</span>&#125; &#123;</span><br><span class="line">        <span class="variable">$rv</span> = <span class="variable">$_</span>.Node | <span class="built_in">Select-Object</span> -Property Name, <span class="variable">$Value</span>, Path, Type</span><br><span class="line">        <span class="variable">$isCollection</span> = <span class="variable">$rv</span>.Name <span class="nomarkup">-eq</span> <span class="string">'Property'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$isCollection</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="variable">$CollectionItem</span> = <span class="string">"[<span class="variable">$i</span>]"</span></span><br><span class="line">          <span class="variable">$i</span>++</span><br><span class="line">          <span class="variable">$rv</span>.Path = ((<span class="variable">$Prefix</span>) -join <span class="string">'.'</span>) + <span class="variable">$CollectionItem</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="variable">$rv</span>.Path = (<span class="variable">$Prefix</span> + <span class="variable">$rv</span>.Name) -join <span class="string">'.'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$rv</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Select-Xml</span> -Xml <span class="variable">$_</span>.Node -XPath <span class="string">'Property'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="variable">$isCollection</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="variable">$PrefixNew</span> = <span class="variable">$Prefix</span>.Clone()</span><br><span class="line">            <span class="variable">$PrefixNew</span>[-<span class="number">1</span>] += <span class="variable">$CollectionItem</span></span><br><span class="line">            Get-Property -Node <span class="variable">$_</span>.Node -Prefix (<span class="variable">$PrefixNew</span> )</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            Get-Property -Node <span class="variable">$_</span>.Node -Prefix (<span class="variable">$Prefix</span> + <span class="variable">$_</span>.Node.Name )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">Process</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="variable">$x</span>++</span><br><span class="line">    <span class="variable">$InputObject</span> |</span><br><span class="line">    <span class="built_in">ConvertTo-Xml</span> -Depth <span class="variable">$Depth</span> |</span><br><span class="line">    <span class="built_in">ForEach-Object</span> &#123; <span class="variable">$_</span>.Objects &#125; |</span><br><span class="line">    <span class="built_in">ForEach-Object</span> &#123; Get-Property <span class="variable">$_</span>.Object -Prefix <span class="variable">$Prefix</span><span class="variable">$x</span>  &#125; |</span><br><span class="line">    <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Name <span class="nomarkup">-like</span> <span class="string">"<span class="variable">$Name</span>"</span> &#125; |</span><br><span class="line">    <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Value <span class="nomarkup">-like</span> <span class="variable">$Value</span> &#125; |</span><br><span class="line">    <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.Type <span class="nomarkup">-like</span> <span class="variable">$Type</span> &#125; |</span><br><span class="line">    <span class="built_in">Where-Object</span> &#123; <span class="variable">$IsNumeric</span>.IsPresent <span class="nomarkup">-eq</span> <span class="literal">$false</span> -or <span class="variable">$_</span>.Value -as [Double] &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>相关图片等已上传<a href="https://gitee.com/chaoyuew/powershell/tree/feature/wechat/SPPS33" target="_blank" rel="noopener">SPPS33</a>, 计算机语言看的再多不如动手，多敲敲代码。我之前工作中对XML的适用比较少，基本就停留在<code>$xml = [XML](Get-Content $Path)</code>的使用上，这一星期自己也学了不少的东西，自己记录文章的过程也是自己学习的过程，共勉之。</p>
<blockquote>
<p>参考链接<br><a href="http://www.powershellmagazine.com/2013/08/19/mastering-everyday-xml-tasks-in-powershell/" target="_blank" rel="noopener">Mastering everyday XML tasks in PowerShell</a><br><a href="https://msdn.microsoft.com/en-us/library/system.xml.xmltextwriter(v=vs.110).aspx" target="_blank" rel="noopener">XmlTextWriter Class</a><br><a href="https://weblogs.asp.net/hajan/xpath-case-insensitivtity" target="_blank" rel="noopener">Case-insensitive XPath query search on XML Document in ASP.NET</a><br><a href="https://becomelotr.wordpress.com/2014/02/09/case-insensitive-select-xml/" target="_blank" rel="noopener">Case-insensitive Select-Xml</a><br><a href="https://msdn.microsoft.com/en-us/library/ms256119(v=vs.110).aspx" target="_blank" rel="noopener">XPath translate()</a><br><a href="https://www.dvteclipse.com/documentation/svlinter/How_to_use_special_characters_in_XML.3F.html" target="_blank" rel="noopener">How to use special characters in XML</a><br><a href="https://stackoverflow.com/questions/2462248/what-is-the-difference-between-name-and-local-name" target="_blank" rel="noopener">XPath name &amp; local-name</a><br><a href="https://stackoverflow.com/questions/47650002/find-xpath-attribute-name-contains-specific-string" target="_blank" rel="noopener">Find XPath attribute name contains specific string</a><br><a href="http://www.w3school.com.cn/xml/xml_namespaces.asp" target="_blank" rel="noopener">XML Namespaces</a><br><a href="https://msdn.microsoft.com/en-us/library/ms950779.aspx?irgwc=1&OCID=AID681541_aff_7593_1243925&tduid=(ir_QFzUMIViAzjLR%3ArxXrwYWzqHUkjT65TaywXW2c0)(7593)(1243925)(TnL5HPStwNw-w4P_zcYwaLF7fqdTCULg5w)()&irclickid=QFzUMIViAzjLR%3ArxXrwYWzqHUkjT65TaywXW2c0" target="_blank" rel="noopener">XML Namespaces and How They Affect XPath and XSLT</a></p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">超速蜗牛</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://chaoyuew.gitee.io/WPS-33-Advanced-Manage-XML.html">https://chaoyuew.gitee.io/WPS-33-Advanced-Manage-XML.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://chaoyuew.gitee.io">超速蜗牛的博客</a>！</span></div></div></article><div id="pagination"><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/WPS-32-Advanced-Auto-Upload-Bulk-Image-To-QiNiuYun.html"><span>Windows PowerShell进阶(32) 七牛云批量自动上传图片</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2019 By 超速蜗牛</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>